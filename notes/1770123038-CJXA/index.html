<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Blog"><title>Go: channel é€šé“</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.16.0/devicon.min.css"><script>
      // This script runs synchronously in the head to prevent FOUC (Flash of Unstyled Content)
      (function() {
        const THEME_KEY = 'nord-theme';
        const DARK = 'dark';
        
        function getStoredTheme() {
          try {
            return localStorage.getItem(THEME_KEY);
          } catch {
            return null;
          }
        }
        
        function getSystemTheme() {
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : 'light';
        }
        
        function getTheme() {
          return getStoredTheme() || getSystemTheme();
        }
        
        function applyTheme(theme) {
          const html = document.documentElement;
          if (theme === DARK) {
            html.classList.add('dark');
          } else {
            html.classList.remove('dark');
          }
        }
        
        // Apply theme immediately before page renders
        applyTheme(getTheme());
      })();
    </script><link rel="stylesheet" href="/_astro/_id_.6ed6JusR.css">
<style>.knowledge-graph-container[data-astro-cid-zjb43jqo]{border:1px solid var(--nord-4);border-radius:8px;background:var(--nord-6);position:relative;overflow:hidden}.knowledge-graph-container[data-astro-cid-zjb43jqo]:fullscreen,.knowledge-graph-container[data-astro-cid-zjb43jqo]::-webkit-full-screen{width:100vw;height:100vh;border-radius:0}.knowledge-graph-container[data-astro-cid-zjb43jqo]:fullscreen .knowledge-graph-wrapper[data-astro-cid-zjb43jqo],.knowledge-graph-container[data-astro-cid-zjb43jqo]::-webkit-full-screen .knowledge-graph-wrapper[data-astro-cid-zjb43jqo]{width:100%;height:100%}.knowledge-graph-toolbar{position:absolute;top:8px;right:8px;z-index:10;display:flex;gap:4px;align-items:center}.knowledge-graph-toolbar-btn{width:32px;height:32px;padding:0;border:1px solid var(--nord-4);border-radius:6px;background:var(--nord-6);color:var(--nord-2);font-size:16px;font-weight:600;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s}.knowledge-graph-toolbar-btn:hover{background:var(--nord-5);color:var(--nord-10)}.knowledge-graph-toolbar-btn:active{background:var(--nord-4)}.knowledge-graph-wrapper[data-astro-cid-zjb43jqo]{width:100%;height:100%;display:flex;align-items:center;justify-content:center}.knowledge-graph-node{cursor:pointer;stroke:#5e81ac;stroke-width:2.5px;transition:all .2s ease}.knowledge-graph-node:hover{stroke-width:2.5px;filter:brightness(1.2)}.knowledge-graph-node.active{stroke:var(--nord-14);stroke-width:3px;filter:drop-shadow(0 0 8px rgba(191,97,106,.5))}.knowledge-graph-node--current{stroke:var(--nord-10);stroke-width:3px;filter:drop-shadow(0 0 6px rgba(94,129,172,.6))}.knowledge-graph-node--outlink{stroke:var(--nord-14);stroke-width:2.5px}.knowledge-graph-node--backlink{stroke:var(--nord-15);stroke-width:2.5px}.knowledge-graph-node--both{stroke:var(--nord-12);stroke-width:2.5px}.knowledge-graph-node--neighbor{stroke:var(--nord-4);stroke-width:2px;opacity:.9}.knowledge-graph-link{stroke:#4c566a;stroke-opacity:.85;stroke-width:2px}.knowledge-graph-link.active{stroke:var(--nord-11);stroke-opacity:.9;stroke-width:2px}.knowledge-graph-label{pointer-events:none;font-size:11px;text-anchor:middle;fill:var(--nord-1);font-weight:500;text-shadow:0 0 3px var(--nord-6)}.knowledge-graph-tooltip{position:absolute;padding:8px 12px;background:var(--nord-0);border:1px solid var(--nord-3);border-radius:4px;font-size:12px;color:var(--nord-6);pointer-events:none;z-index:1000;box-shadow:0 2px 8px #0000004d;white-space:nowrap}.knowledge-graph-tooltip-type{color:var(--nord-8);font-size:11px}.knowledge-graph-legend{position:absolute;bottom:8px;left:8px;z-index:10;display:flex;flex-wrap:wrap;gap:8px 12px;font-size:11px;color:var(--nord-2)}.kg-legend-item{display:inline-flex;align-items:center;gap:4px}.kg-legend--current{color:var(--nord-10)}.kg-legend--outlink{color:var(--nord-14)}.kg-legend--backlink{color:var(--nord-15)}.kg-legend--both{color:var(--nord-12)}.kg-legend--neighbor{color:var(--nord-4);opacity:.9}
html{scroll-behavior:smooth}article[data-astro-cid-v5yihett]{word-break:break-word}
</style></head> <body class="text-nord-3 dark:text-nord-5 transition-all bg-gradient-light"> <header class="border-b border-nord-5 dark:border-nord-1 bg-nord-6 dark:bg-nord-0"> <nav class="max-w-4xl mx-auto px-4 py-5 flex items-center justify-between gap-4"> <div class="flex items-center gap-2 min-w-0"> <a href="/" title="Liu" class="shrink-0 p-1.5 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-lg dark:hover:shadow-nord-8/20 active:scale-95"> <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg> </a> <h1 class="text-xl font-bold truncate"> <a href="/" class="text-nord-2 dark:text-nord-6 hover:text-nord-10 dark:hover:text-nord-8 transition-colors"> Liu </a> </h1> </div> <div class="flex items-center gap-2 shrink-0"> <a href="https://github.com/gh-liu" title="GitHub" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex active:scale-95"> <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-label="GitHub"> <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path> </svg> </a> <a href="https://x.com" title="X" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex active:scale-95"> <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-label="X"> <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24h-6.657l-5.207-6.807-5.975 6.807H2.306l7.644-8.74-8.179-10.76h6.467l4.713 6.231 5.429-6.231zM17.002 18.807h1.844L6.983 4.126H5.025l11.977 14.681z"></path> </svg> </a> <span class="w-px h-4 bg-nord-4 dark:bg-nord-2 shrink-0" aria-hidden="true"></span> <div class="relative series-dropdown" id="series-dropdown-root"> <a href="/notes/series" title="Series" aria-expanded="false" aria-haspopup="true" aria-controls="series-dropdown-panel" id="series-dropdown-trigger" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex active:scale-95"> <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M4 6h16M4 12h16M4 18h16"></path> </svg> </a> <div id="series-dropdown-panel" class="absolute right-0 top-full mt-1 py-2 min-w-[12rem] max-h-[70vh] overflow-y-auto rounded-lg border border-nord-4 dark:border-nord-2 bg-nord-6 dark:bg-nord-1 shadow-lg z-50 hidden" role="menu"> <div id="series-dropdown-list" class="py-1"> <span class="block px-3 py-2 text-xs text-nord-4 dark:text-nord-3">åŠ è½½ä¸­â€¦</span> </div> <div class="border-t border-nord-4 dark:border-nord-2 pt-1 mt-1"> <a href="/notes/series" class="block px-3 py-2 text-sm text-nord-9 dark:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-2 transition-colors">
æŸ¥çœ‹å…¨éƒ¨ç³»åˆ— â†’
</a> </div> </div> </div> <div class="relative tags-dropdown" id="tags-dropdown-root"> <a href="/notes/tags" title="Tags" aria-expanded="false" aria-haspopup="true" aria-controls="tags-dropdown-panel" id="tags-dropdown-trigger" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex active:scale-95"> <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M5 3h14v17L12 17l-7 3V3z"></path> </svg> </a> <div id="tags-dropdown-panel" class="absolute right-0 top-full mt-1 py-2 min-w-[12rem] max-h-[70vh] overflow-y-auto rounded-lg border border-nord-4 dark:border-nord-2 bg-nord-6 dark:bg-nord-1 shadow-lg z-50 hidden" role="menu"> <div id="tags-dropdown-list" class="py-1"> <span class="block px-3 py-2 text-xs text-nord-4 dark:text-nord-3">åŠ è½½ä¸­â€¦</span> </div> <div class="border-t border-nord-4 dark:border-nord-2 pt-1 mt-1"> <a href="/notes/tags" class="block px-3 py-2 text-sm text-nord-9 dark:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-2 transition-colors">
æŸ¥çœ‹å…¨éƒ¨æ ‡ç­¾ â†’
</a> </div> </div> </div> <div class="search-container" id="search-wrapper" data-astro-cid-t47yvtpn><button id="search-toggle" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex" aria-label="Search notes" title="Search (âŒ˜K)" data-astro-cid-t47yvtpn><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" data-astro-cid-t47yvtpn><circle cx="11" cy="11" r="8" data-astro-cid-t47yvtpn></circle><path d="m21 21-4.35-4.35" data-astro-cid-t47yvtpn></path></svg></button><div id="search-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-start justify-center pt-20 backdrop-blur-sm" data-astro-cid-t47yvtpn><div class="bg-nord-6 dark:bg-nord-0 rounded-2xl shadow-2xl w-full max-w-2xl border border-nord-5 dark:border-nord-1 max-h-[70vh] flex flex-col overflow-hidden animate-fade-in" data-astro-cid-t47yvtpn><div class="p-4 border-b border-nord-5 dark:border-nord-1" data-astro-cid-t47yvtpn><input type="search" id="search-input" placeholder="Search notes... (use #tag for tag search)" class="w-full px-4 py-2 bg-nord-5 dark:bg-nord-1 text-nord-2 dark:text-nord-6 placeholder-nord-3 dark:placeholder-nord-4 rounded focus:outline-none focus:ring-2 focus:ring-nord-9 dark:focus:ring-nord-8" autocomplete="off" data-astro-cid-t47yvtpn></div><div id="search-results" class="flex-1 overflow-y-auto p-4" data-astro-cid-t47yvtpn><p class="text-nord-3 dark:text-nord-5 text-sm" data-astro-cid-t47yvtpn>Type to search...</p></div><div class="p-3 border-t border-nord-5 dark:border-nord-1 text-xs text-nord-3 dark:text-nord-4" data-astro-cid-t47yvtpn><p data-astro-cid-t47yvtpn>Press <kbd class="px-1 py-0.5 bg-nord-4 dark:bg-nord-2 rounded" data-astro-cid-t47yvtpn>Esc</kbd> to close | Use <kbd class="px-1 py-0.5 bg-nord-4 dark:bg-nord-2 rounded" data-astro-cid-t47yvtpn>#tag</kbd> to search by tag</p></div></div></div></div><script>(function(){const pagefindUrl = "/pagefind/pagefind.js";

  if (!globalThis.pagefindLoaded) {
    globalThis.pagefindLoaded = true;
    
    let pagefind;
    let searchInput;
    let searchModal;
    let searchResults;
    let isSearchOpen = false;

    async function initSearch() {
      if (typeof window === "undefined") return;

      try {
        pagefind = await import(pagefindUrl);
        await pagefind.init();
      } catch (error) {
        console.log("Search not available.", error);
        return;
      }

      searchInput = document.getElementById("search-input");
      searchModal = document.getElementById("search-modal");
      searchResults = document.getElementById("search-results");
      const toggleBtn = document.getElementById("search-toggle");

      if (!searchInput || !searchModal || !searchResults || !toggleBtn) return;

      toggleBtn.addEventListener("click", () => {
        openSearch();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeSearch();
        }
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          isSearchOpen ? closeSearch() : openSearch();
        }
      });

      searchModal.addEventListener("click", (e) => {
        if (e.target === searchModal) closeSearch();
      });

      searchInput.addEventListener("input", async (e) => {
        const query = e.target.value.trim();
        if (!query) {
          searchResults.innerHTML = '<p class="text-nord-3 dark:text-nord-5 text-sm">Type to search...</p>';
          return;
        }

        // Check if query starts with #tag
        const isTagSearch = query.startsWith('#');
        let results;
        
        if (isTagSearch) {
          // Tag search
          const tag = query.slice(1).toUpperCase();
          results = await pagefind.search(`tag:${tag}`);
        } else {
          // Regular text search
          results = await pagefind.search(query);
        }

        if (results.results.length === 0) {
          searchResults.innerHTML = '<p class="text-nord-3 dark:text-nord-5 text-sm">No results found.</p>';
          return;
        }

        let html = '<ul class="space-y-2">';
        for (const result of results.results) {
          const data = await result.data();
          // Extract title from h1 or use URL slug as fallback
          const title = data.meta?.title || data.title || (data.url.split('/').pop() || 'untitled').replace(/-/g, ' ');
          html += `<li><a href="${data.url}" class="block p-3 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-2 text-nord-9 dark:text-nord-8 hover:text-nord-10 dark:hover:text-nord-7 transition-all hover:shadow-md duration-200 border border-transparent hover:border-nord-9 dark:hover:border-nord-8"><div class="font-medium">${title}</div><div class="text-xs text-nord-3 dark:text-nord-5 mt-1 line-clamp-2">${data.excerpt || ""}</div></a></li>`;
        }
        searchResults.innerHTML = html + "</ul>";
      });
    }

    function openSearch() {
      isSearchOpen = true;
      searchModal.classList.remove("hidden");
      searchInput.focus();
      document.body.style.overflow = "hidden";
    }

    function closeSearch() {
      isSearchOpen = false;
      searchModal.classList.add("hidden");
      searchInput.value = "";
      searchResults.innerHTML = '<p class="text-nord-3 dark:text-nord-5 text-sm">Type to search...</p>';
      document.body.style.overflow = "";
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initSearch);
    } else {
      initSearch();
    }
  }
})();</script> <button id="theme-toggle" aria-label="Toggle theme" title="Toggle theme" class="group relative p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-3 dark:text-nord-4 transition-all duration-200 ease-out hover:scale-110 inline-flex"> <span class="inline-block transition-transform duration-200 ease-out group-hover:rotate-12"> <svg id="sun-icon" class="w-4 h-4 text-nord-13 hidden dark:block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line> </svg> <svg id="moon-icon" class="w-4 h-4 text-nord-9 block dark:hidden" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path> </svg> </span> </button> <script>
  const THEME_KEY = 'nord-theme';
  const DARK = 'dark';
  
  function getStoredTheme() {
    return localStorage.getItem(THEME_KEY);
  }
  
  function getSystemTheme() {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : 'light';
  }
  
  function getTheme() {
    return getStoredTheme() || getSystemTheme();
  }
  
  function applyTheme(theme) {
    const html = document.documentElement;
    if (theme === DARK) {
      html.classList.add('dark');
    } else {
      html.classList.remove('dark');
    }
  }
  
  function toggleTheme() {
    const currentTheme = getTheme();
    const newTheme = currentTheme === DARK ? 'light' : DARK;
    localStorage.setItem(THEME_KEY, newTheme);
    applyTheme(newTheme);
  }
  
  const themeToggle = document.getElementById('theme-toggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', toggleTheme);
  }
</script> </div> </nav> </header> <main class="max-w-4xl mx-auto px-4 py-12" data-pagefind-body> <aside id="toc-sidebar" class="fixed left-0 top-0 h-screen w-56 bg-nord-6 dark:bg-nord-0 border-r border-nord-5 dark:border-nord-1 overflow-y-auto overflow-x-hidden pt-4 pb-4 transition-transform duration-300 -translate-x-full z-50" data-astro-cid-vrmg3htk> <nav class="px-4 space-y-1" data-astro-cid-vrmg3htk> <!-- Close button --> <button id="toc-close" class="flex justify-end w-full mb-4 p-2 text-nord-2 dark:text-nord-6 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors" aria-label="Close navigation" data-astro-cid-vrmg3htk> <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" data-astro-cid-vrmg3htk> <path d="M18 6L6 18M6 6l12 12" data-astro-cid-vrmg3htk></path> </svg> </button> <h3 class="text-xs font-bold text-nord-2 dark:text-nord-6 uppercase tracking-widest px-2 py-3 border-b border-nord-5 dark:border-nord-1" data-astro-cid-vrmg3htk>
On this page
</h3> <ul class="space-y-0.5 text-sm mt-4" data-astro-cid-vrmg3htk> <li class="toc-item pl-0" data-astro-cid-vrmg3htk> <a href="#11--åˆ›å»º" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="2" data-astro-cid-vrmg3htk> 1.1 Â· åˆ›å»º </a> </li><li class="toc-item pl-0" data-astro-cid-vrmg3htk> <a href="#12--ç›¸å…³æ“ä½œ" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="2" data-astro-cid-vrmg3htk> 1.2 Â· ç›¸å…³æ“ä½œ </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#121--select-æ“ä½œ" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 1.2.1 Â· select æ“ä½œ </a> </li><li class="toc-item pl-0" data-astro-cid-vrmg3htk> <a href="#13--inside-chan" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="2" data-astro-cid-vrmg3htk> 1.3 Â· Inside Chan </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#131--åˆ›å»º" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 1.3.1 Â· åˆ›å»º </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#132--å…³é—­" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 1.3.2 Â· å…³é—­ </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#133--å‘é€æ¥å—" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 1.3.3 Â· å‘é€/æ¥å— </a> </li><li class="toc-item pl-0" data-astro-cid-vrmg3htk> <a href="#14--patterns" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="2" data-astro-cid-vrmg3htk> 1.4 Â· Patterns </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#141--1-or-done-æ¨¡å¼" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 1.4.1 Â· 1. Or-Done æ¨¡å¼ </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#142--2-æ‰‡å…¥æ¨¡å¼-fan-in" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 1.4.2 Â· 2. æ‰‡å…¥æ¨¡å¼ (Fan-In) </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#143--3-æ‰‡å‡ºæ¨¡å¼-fan-out" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 1.4.3 Â· 3. æ‰‡å‡ºæ¨¡å¼ (Fan-Out) </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#144--4-stream-æ¨¡å¼" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 1.4.4 Â· 4. Stream æ¨¡å¼ </a> </li><li class="toc-item pl-0" data-astro-cid-vrmg3htk> <a href="#15--æ€è€ƒ" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="2" data-astro-cid-vrmg3htk> 1.5 Â· æ€è€ƒ </a> </li><li class="toc-item pl-0" data-astro-cid-vrmg3htk> <a href="#16--links" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="2" data-astro-cid-vrmg3htk> 1.6 Â· links </a> </li> </ul> </nav> </aside> <!-- Toggle button - fixed at left edge --> <button id="toc-toggle" class="fixed left-0 top-4 p-3 rounded-r-lg bg-nord-9 dark:bg-nord-8 text-nord-6 dark:text-nord-0 hover:bg-nord-10 dark:hover:bg-nord-7 hover:text-nord-6 dark:hover:text-nord-0 transition-colors shadow-lg z-40" aria-label="Toggle sidebar" title="Toggle sidebar (â† â†’)" data-astro-cid-vrmg3htk> <svg id="toggle-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" data-astro-cid-vrmg3htk> <path d="M4 6h16M4 12h16M4 18h16" data-astro-cid-vrmg3htk></path> </svg> </button> <script>
  const TOC_KEY = 'toc-open';
  const sidebar = document.getElementById('toc-sidebar');
  const toggle = document.getElementById('toc-toggle');
  const closeBtn = document.getElementById('toc-close');

  function getSidebarState() {
    return localStorage.getItem(TOC_KEY) !== 'false';
  }

  function setSidebarState(open) {
    localStorage.setItem(TOC_KEY, open ? 'true' : 'false');
  }

  function updateSidebar() {
    const isOpen = getSidebarState();
    if (sidebar) {
      if (isOpen) {
        sidebar.classList.remove('-translate-x-full');
      } else {
        sidebar.classList.add('-translate-x-full');
      }
    }
  }

  function toggleSidebar() {
    const isOpen = getSidebarState();
    setSidebarState(!isOpen);
    updateSidebar();
  }

  // Initialize
  updateSidebar();

  // Event listeners
  if (toggle) {
    toggle.addEventListener('click', toggleSidebar);
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', toggleSidebar);
  }

  // Keyboard shortcut: left/right arrow to toggle
  document.addEventListener('keydown', (e) => {
    if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && e.ctrlKey) {
      e.preventDefault();
      toggleSidebar();
    }
  });

  // Highlight current section on scroll
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          document.querySelectorAll('.toc-item a').forEach((link) => {
            link.classList.remove('text-nord-9', 'dark:text-nord-8', 'font-semibold', 'bg-nord-5', 'dark:bg-nord-1');
            link.classList.add('text-nord-3', 'dark:text-nord-4');
          });
          const activeLink = document.querySelector(
            `.toc-item a[href="#${entry.target.id}"]`
          );
          if (activeLink) {
            activeLink.classList.remove('text-nord-3', 'dark:text-nord-4');
            activeLink.classList.add('text-nord-9', 'dark:text-nord-8', 'font-semibold', 'bg-nord-5', 'dark:bg-nord-1');
          }
        }
      });
    },
    { rootMargin: '-50% 0px -50% 0px' }
  );

  document.querySelectorAll('h2, h3').forEach((heading) => {
    if (heading.id) {
      observer.observe(heading);
    }
  });

  // Close sidebar on link click
  document.querySelectorAll('.toc-item a').forEach((link) => {
    link.addEventListener('click', () => {
      setSidebarState(false);
      updateSidebar();
    });
  });
</script>  <article class="prose prose-nord dark:prose-nord max-w-none
      prose-headings:font-serif
      prose-code:before:content-none prose-code:after:content-none" data-astro-cid-v5yihett> <header class="mb-8" data-astro-cid-v5yihett> <h1 class="mb-3" data-pagefind-meta="title" data-astro-cid-v5yihett>Go: channel é€šé“</h1> <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-4" data-astro-cid-v5yihett> <div class="text-sm text-nord-3 dark:text-nord-5" data-astro-cid-v5yihett> <div> <div class="flex flex-wrap gap-2 mb-2"> <span class="inline-flex items-center gap-1 px-2.5 py-1 text-xs bg-nord-7 dark:bg-nord-7 text-nord-0 dark:text-nord-0 rounded font-medium"> <span>ğŸ“…</span> <span>2026-02-05</span> </span> <span class="inline-flex items-center gap-1 px-2.5 py-1 text-xs bg-nord-8 dark:bg-nord-8 text-nord-0 dark:text-nord-0 rounded font-medium"> <span>âœï¸</span> <span>2026-02-13</span> </span> <a href="/notes/series/inside-go" class="inline-flex items-center gap-1 px-2.5 sm:px-3 py-1.5 sm:py-1 text-xs sm:text-xs font-semibold rounded bg-nord-6 dark:bg-nord-2/60 shadow-sm dark:shadow-md transition-all duration-200 ease-out hover:shadow-md dark:hover:shadow-lg hover:translate-y-[-1px] tag-text-green-light dark:tag-text-green-dark !no-underline hover:!no-underline" title="ç³»åˆ—ï¼šInside Go"> <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M4 6h16M4 12h16M4 18h16"></path> </svg> <span>Inside Go</span>  </a> <div class="flex flex-wrap gap-2"> <a href="/notes/tag/CS" class="inline-flex items-center gap-1 px-2.5 sm:px-3 py-1.5 sm:py-1 text-xs sm:text-xs font-semibold rounded bg-nord-6 dark:bg-nord-2/60 shadow-sm dark:shadow-md transition-all duration-200 ease-out hover:shadow-md dark:hover:shadow-lg hover:translate-y-[-1px] tag-text-blue-light dark:tag-text-blue-dark !no-underline hover:!no-underline" title="Tag: CS"> <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M5 3h14v17L12 17l-7 3V3z"></path> </svg> <span>CS</span>  </a><a href="/notes/tag/GO" class="inline-flex items-center gap-1 px-2.5 sm:px-3 py-1.5 sm:py-1 text-xs sm:text-xs font-semibold rounded bg-nord-6 dark:bg-nord-2/60 shadow-sm dark:shadow-md transition-all duration-200 ease-out hover:shadow-md dark:hover:shadow-lg hover:translate-y-[-1px] tag-text-blue-light dark:tag-text-blue-dark !no-underline hover:!no-underline" title="Tag: GO"> <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M5 3h14v17L12 17l-7 3V3z"></path> </svg> <span>GO</span>  </a> </div> </div> </div> </div> <div class="text-sm" data-astro-cid-v5yihett> <div> <div class="flex items-center gap-4"> <!-- Back to notes link - removed, now in footer --> <!-- Show only links and backlinks stats --> <!-- Outlinks -->  <button class="open-outlinks-btn flex items-center gap-2 px-3 py-1 rounded hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-9 dark:text-nord-8 hover:text-nord-10 dark:hover:text-nord-7 transition-colors" aria-label="Open 2 outlinks" title="Links to 2 note(s)"> <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M13 7l5 5m0 0l-5 5m5-5H6"></path> </svg> <span class="font-medium">2 links</span> </button>  <!-- Backlinks -->  <!-- No links message -->  </div> <!-- Modals --> <div id="outlinks-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"> <div class="bg-nord-6 dark:bg-nord-0 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-nord-5 dark:border-nord-1"> <!-- Header --> <div class="sticky top-0 bg-nord-6 dark:bg-nord-0 border-b border-nord-5 dark:border-nord-1 px-6 py-4 flex items-center justify-between"> <h2 class="text-lg font-semibold text-nord-2 dark:text-nord-6"> Outlinks <span class="text-sm font-normal text-nord-3 dark:text-nord-5 ml-2">
(2)
</span> </h2> <button class="close-modal p-1 text-nord-3 dark:text-nord-4 hover:bg-nord-5 dark:hover:bg-nord-1 hover:text-nord-2 dark:hover:text-nord-5 rounded transition-colors" aria-label="Close modal"> <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M18 6L6 18M6 6l12 12"></path> </svg> </button> </div> <!-- Content --> <div class="p-6"> <ul class="space-y-2"> <li> <a href="/notes/1770786730-PFOI" class="block p-3 rounded hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-9 dark:text-nord-8 hover:text-nord-10 dark:hover:text-nord-7 transition-colors"> <div class="font-medium">Go: goroutine åç¨‹</div> <div class="text-xs text-nord-3 dark:text-nord-5 mt-1 break-all"> /notes/1770786730-PFOI </div> </a> </li><li> <a href="/notes/1770123038-RTOD" class="block p-3 rounded hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-9 dark:text-nord-8 hover:text-nord-10 dark:hover:text-nord-7 transition-colors"> <div class="font-medium">Go: compile ç¼–è¯‘å™¨</div> <div class="text-xs text-nord-3 dark:text-nord-5 mt-1 break-all"> /notes/1770123038-RTOD </div> </a> </li> </ul> </div> </div> </div> <script>(function(){const modalId = "outlinks-modal";
const type = "outlinks";

  const modal = document.getElementById(modalId);
  const closeButtons = modal ? modal.querySelectorAll('.close-modal') : [];

  // Create camelCase function name: "backlinks" -> "openBacklinksModal"
  const functionName = `open${type.charAt(0).toUpperCase() + type.slice(1)}Modal`;

  // Open modal
  window[functionName] = function() {
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  };

  // Close modal
  function closeModal() {
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  // Close button listeners
  closeButtons.forEach((btn) => {
    btn.addEventListener('click', closeModal);
  });

  // Close on background click
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });
  }

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeModal();
    }
  });
})();</script> <div id="backlinks-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"> <div class="bg-nord-6 dark:bg-nord-0 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-nord-5 dark:border-nord-1"> <!-- Header --> <div class="sticky top-0 bg-nord-6 dark:bg-nord-0 border-b border-nord-5 dark:border-nord-1 px-6 py-4 flex items-center justify-between"> <h2 class="text-lg font-semibold text-nord-2 dark:text-nord-6"> Backlinks <span class="text-sm font-normal text-nord-3 dark:text-nord-5 ml-2">
(0)
</span> </h2> <button class="close-modal p-1 text-nord-3 dark:text-nord-4 hover:bg-nord-5 dark:hover:bg-nord-1 hover:text-nord-2 dark:hover:text-nord-5 rounded transition-colors" aria-label="Close modal"> <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M18 6L6 18M6 6l12 12"></path> </svg> </button> </div> <!-- Content --> <div class="p-6"> <p class="text-nord-3 dark:text-nord-5 text-center py-8">
No backlinks found
</p> </div> </div> </div> <script>(function(){const modalId = "backlinks-modal";
const type = "backlinks";

  const modal = document.getElementById(modalId);
  const closeButtons = modal ? modal.querySelectorAll('.close-modal') : [];

  // Create camelCase function name: "backlinks" -> "openBacklinksModal"
  const functionName = `open${type.charAt(0).toUpperCase() + type.slice(1)}Modal`;

  // Open modal
  window[functionName] = function() {
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  };

  // Close modal
  function closeModal() {
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  // Close button listeners
  closeButtons.forEach((btn) => {
    btn.addEventListener('click', closeModal);
  });

  // Close on background click
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });
  }

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeModal();
    }
  });
})();</script> <script>
  // Outlinks button - calls window.openOutlinksModal()
  document.querySelectorAll('.open-outlinks-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      if (window.openOutlinksModal) {
        window.openOutlinksModal();
      }
    });
  });

  // Backlinks button - calls window.openBacklinksModal()
  document.querySelectorAll('.open-backlinks-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      if (window.openBacklinksModal) {
        window.openBacklinksModal();
      }
    });
  });
</script> </div> </div> </div> </header>    <pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#88C0D0">go</span><span style="color:#A3BE8C"> version</span><span style="color:#616E88"> # go version go1.25.6</span></span></code></pre>
<h1 id="1--channel-é€šé“">1 Â· Channel é€šé“</h1>
<blockquote>
<p>A channel provides a mechanism for concurrently executing functions to communicate by sending and receiving values of a specified element type.</p>
<p>é€šé“æä¾›äº†ä¸€ç§æœºåˆ¶ï¼šç”¨äºåœ¨å¹¶å‘æ‰§è¡Œçš„å‡½æ•°ç›´æ¥å‘é€/æ¥å—ç‰¹å®šç±»å‹çš„å€¼ã€‚</p>
<p>ChannelType = ( â€œchanâ€ | â€œchanâ€ â€&#x3C;-â€ | â€&#x3C;-â€ â€œchanâ€ ) ElementType .</p>
<p>å¯é€‰æ‹©çš„ &#x3C;- æ“ä½œç¬¦æ ‡è¯†chançš„æ–¹å‘ï¼šå‘é€ã€æ¥å—ï¼›å¦‚æœæœªç»™å®šï¼Œåˆ™chanæ˜¯åŒå‘çš„ï¼ˆå¯å‘é€ã€å¯æ¥å—ï¼‰</p>
</blockquote>
<p>channelç¿»è¯‘æˆ<code>é€šé“</code>ï¼š é‚£ä¹ˆ
<code>é€šé“</code>ä¼šæœ‰ä»€ä¹ˆç±»å‹ï¼š ç¼“å†²ï¼Œéç¼“å†²ï¼›
<code>é€šé“</code>ä¼šæœ‰ä»€ä¹ˆæ“ä½œï¼š åˆ›å»ºï¼Œå‘é€ï¼Œæ¥æ”¶ï¼Œå…³é—­ï¼›</p>
<p>channelåˆ†ä¸º å¸¦ç¼“å†²ã€ä¸å¸¦ç¼“å†²ä¸¤ç§ï¼›å¯çœ‹ä½œå¼‚æ­¥ï¼ˆå¸¦ç¼“å†²ï¼‰ã€åŒæ­¥ï¼ˆä¸å¸¦ç¼“å†²ï¼‰æ¨¡å¼ï¼›
å¯¹channelçš„å‘é€ï¼Œæ¥æ”¶ç­‰æ“ä½œï¼Œä¼šåœ¨ç¼–è¯‘å™¨ï¼Œè½¬æ¢æˆåº•å±‚çš„å‘é€ï¼Œæ¥æ”¶ç­‰å‡½æ•°ï¼›</p>
<p>chan è¿æ¥ <a href="/notes/1770786730-PFOI">goroutine</a>ï¼Œruntime è´Ÿè´£è°ƒåº¦
chan æ˜¯ goroutine ä¹‹é—´çš„åŒæ­¥/é€šä¿¡å¯¹è±¡ï¼›è°åœ¨ç­‰å‘ã€è°åœ¨ç­‰æ”¶éƒ½æŒ‚åœ¨ hchan çš„ sendq/recvq ä¸Š</p>
<h2 id="11--åˆ›å»º">1.1 Â· åˆ›å»º</h2>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#616E88">// 1. æ— ç¼“å†²</span></span>
<span class="line"><span style="color:#D8DEE9">ch1</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#616E88">// 2. æœ‰ç¼“å†²</span></span>
<span class="line"><span style="color:#D8DEE9">ch2</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">,</span><span style="color:#B48EAD"> 2</span><span style="color:#ECEFF4">)</span><span style="color:#616E88"> // ç¬¬2ä¸ªå‚æ•°è¡¨ç¤ºchançš„å®¹é‡ï¼›ä¸º0æˆ–ä¸å¡«è¡¨ç¤ºæ— ç¼“å†²</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// NOTEï¼šæœªåˆå§‹åŒ–çš„chanä¸ºnilï¼Œä¸å¯ä»¥å‘é€/æ¥å—å€¼</span></span>
<span class="line"><span style="color:#81A1C1">var</span><span style="color:#D8DEE9"> chan1</span><span style="color:#81A1C1"> chan</span><span style="color:#81A1C1"> int</span></span>
<span class="line"><span style="color:#88C0D0">print</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">chan1</span><span style="color:#81A1C1"> ==</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4">)</span><span style="color:#616E88"> // true</span></span></code></pre>
<h2 id="12--ç›¸å…³æ“ä½œ">1.2 Â· ç›¸å…³æ“ä½œ</h2>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#616E88">// 1. å‘é€</span></span>
<span class="line"><span style="color:#616E88">// SendStmt = Channel "&#x3C;-" Expression .</span></span>
<span class="line"><span style="color:#D8DEE9">ch</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#B48EAD"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 2. æ¥å—</span></span>
<span class="line"><span style="color:#D8DEE9">v2</span><span style="color:#81A1C1">    :=</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9">ch</span></span>
<span class="line"><span style="color:#D8DEE9">x</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ok</span><span style="color:#81A1C1"> :=</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9">ch</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 3. å…³é—­</span></span>
<span class="line"><span style="color:#D8DEE9">ch</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#88C0D0">close</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ch</span><span style="color:#ECEFF4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 4. è·å–é•¿åº¦ã€å®¹é‡</span></span>
<span class="line"><span style="color:#88C0D0">len</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ch</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#88C0D0">cap</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ch</span><span style="color:#ECEFF4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 5. éå†</span></span>
<span class="line"><span style="color:#81A1C1">for</span><span style="color:#D8DEE9"> v1</span><span style="color:#81A1C1"> :=</span><span style="color:#81A1C1"> range</span><span style="color:#D8DEE9"> ch</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 6. select æ“ä½œï¼šç”¨äºåœ¨å¤šä¸ª channel çš„å‘é€/æ¥æ”¶æ“ä½œä¸­é€‰æ‹©æœ€å…ˆå°±ç»ªçš„é‚£ä¸ª</span></span>
<span class="line"><span style="color:#81A1C1">select</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">	case</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9">chan1</span><span style="color:#ECEFF4">:</span></span>
<span class="line"><span style="color:#81A1C1">	case</span><span style="color:#D8DEE9"> chan2</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#B48EAD"> 2</span><span style="color:#ECEFF4">:</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span></code></pre>
<p>NOTE:</p>





































<table><thead><tr><th>Operation</th><th>nil</th><th>empty</th><th>full</th><th>not full&#x26;empty</th><th>closed</th></tr></thead><tbody><tr><td>receive</td><td>é˜»å¡</td><td>é˜»å¡</td><td>è¯»å…ƒç´ </td><td>è¯»å…ƒç´ </td><td>è¿”å›æœªè¯»å…ƒç´ ï¼Œæ— å…ƒç´ åˆ™é›¶å€¼</td></tr><tr><td>send</td><td>é˜»å¡</td><td>å†™å…ƒç´ </td><td>é˜»å¡</td><td>å†™å…ƒç´ </td><td>panic</td></tr><tr><td>close</td><td>panic</td><td>-</td><td>-</td><td>-</td><td>panic</td></tr></tbody></table>
<h3 id="121--select-æ“ä½œ">1.2.1 Â· select æ“ä½œ</h3>
<blockquote>
<p><a href="https://go.dev/ref/spec#Select_statements">https://go.dev/ref/spec#Select_statements</a></p>
</blockquote>
<p>æ‰§è¡Œé€»è¾‘ï¼š</p>
<ol>
<li>è¿›å…¥ select æ—¶ï¼šä»å·¦åˆ°å³è®¡ç®—æ‰€æœ‰ case çš„ channel å’Œå‘é€å€¼ï¼Œåªç®—ä¸€æ¬¡</li>
<li>é€‰æ‹© caseï¼š
<ul>
<li>æœ‰è‡³å°‘ä¸€ä¸ª case å¯æ‰§è¡Œ â†’ éšæœºé€‰ä¸€ä¸ªæ‰§è¡Œ</li>
<li>æ²¡æœ‰å¯æ‰§è¡Œ case ä¸”æœ‰ default â†’ æ‰§è¡Œ default</li>
<li>æ²¡æœ‰å¯æ‰§è¡Œ case ä¸”æ—  default â†’ ä¸€ç›´é˜»å¡</li>
</ul>
</li>
<li>æ‰§è¡Œï¼šæ‰§è¡Œè¢«é€‰ä¸­çš„ case ä»£ç ï¼›å¦‚æœæ˜¯æ¥æ”¶ä¸”å¸¦èµ‹å€¼ï¼Œåˆ™èµ‹å€¼åå†æ‰§è¡Œ</li>
</ol>
<p>NOTE: default çš„å¦™ç”¨ï¼Œå®ç°éé˜»å¡æ“ä½œ</p>
<h2 id="13--inside-chan">1.3 Â· Inside Chan</h2>
<h3 id="131--åˆ›å»º">1.3.1 Â· åˆ›å»º</h3>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#D8DEE9">ch</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span></span></code></pre>
<p>æŸ¥çœ‹<a href="/notes/1770123038-RTOD">æ±‡ç¼–</a>ï¼Œå¯çŸ¥åˆ›å»ºchançš„å‡½æ•°æ˜¯<code>runtime.makechan</code>ï¼›</p>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#616E88">// ç”¨æˆ·ä»£ç åˆ›å»ºçš„chanæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘runtimeåŒ…çš„hchanå€¼ï¼Œæ‰€ä»¥chanæ˜¯ä¸€ç§å¼•ç”¨ç±»å‹</span></span>
<span class="line"><span style="color:#616E88">// tæ˜¯chanå†…çš„å…ƒç´ ç±»å‹ï¼Œsizeæ˜¯ç¼“å†²åŒºå¤§å°</span></span>
<span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> makechan</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">t</span><span style="color:#81A1C1"> *</span><span style="color:#D8DEE9FF">chantype</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> size</span><span style="color:#81A1C1"> int64</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> *</span><span style="color:#D8DEE9FF">hchan </span><span style="color:#ECEFF4">{}</span></span></code></pre>
<p>æŸ¥çœ‹chançš„å®šä¹‰ã€makechanæºç </p>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#616E88">// 1. chan å®šä¹‰ï¼šå“ªä¸ªgoroutineåœ¨ç­‰å‘/æ”¶éƒ½æŒ‚åœ¨ hchan çš„ sendq/recvq ä¸Š</span></span>
<span class="line"><span style="color:#81A1C1">type</span><span style="color:#D8DEE9FF"> hchan </span><span style="color:#81A1C1">struct</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">	qcount</span><span style="color:#81A1C1">   uint</span><span style="color:#616E88">           // chané˜Ÿåˆ—é‡Œé¢çš„å…ƒç´ æ•°é‡(ç”¨äºç¼“å­˜å‹chan)</span></span>
<span class="line"><span style="color:#D8DEE9">	dataqsiz</span><span style="color:#81A1C1"> uint</span><span style="color:#616E88">           // chanåº•å±‚å¾ªç¯æ•°ç»„çš„é•¿åº¦(0ä¸ºéç¼“å­˜)</span></span>
<span class="line"><span style="color:#D8DEE9">	buf</span><span style="color:#D8DEE9FF">      unsafe</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">Pointer </span><span style="color:#616E88">// æŒ‡å‘åº•å±‚å¾ªç¯æ•°ç»„çš„æŒ‡é’ˆï¼Œåªæœ‰ç¼“å†²å‹çš„ channel æ‰æœ‰</span></span>
<span class="line"><span style="color:#D8DEE9">	elemsize</span><span style="color:#81A1C1"> uint16</span><span style="color:#616E88">         // chanä¸­çš„å…ƒç´ å¤§å°</span></span>
<span class="line"><span style="color:#D8DEE9">	closed</span><span style="color:#81A1C1">   uint32</span><span style="color:#616E88">         // chanæ˜¯å¦å…³é—­</span></span>
<span class="line"><span style="color:#D8DEE9">	elemtype</span><span style="color:#81A1C1"> *</span><span style="color:#D8DEE9FF">_type         </span><span style="color:#616E88">// chanä¸­çš„å…ƒç´ ç±»å‹</span></span>
<span class="line"><span style="color:#616E88">	                        // ï¼ç”¨äºç¼“å­˜å‹chan</span></span>
<span class="line"><span style="color:#D8DEE9">	sendx</span><span style="color:#81A1C1">    uint</span><span style="color:#616E88">           // å·²ç»å‘é€çš„å…ƒç´ åœ¨åº•å±‚å¾ªç¯æ•°ç»„çš„ç´¢å¼•</span></span>
<span class="line"><span style="color:#D8DEE9">	recvx</span><span style="color:#81A1C1">    uint</span><span style="color:#616E88">           // å·²ç»æ¥æ”¶çš„å…ƒç´ åœ¨åº•å±‚å¾ªç¯æ•°ç»„çš„ç´¢å¼•</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	                        // é‡ç‚¹ï¼å…³è”çš„goroutine</span></span>
<span class="line"><span style="color:#D8DEE9">	recvq</span><span style="color:#D8DEE9FF">    waitq          </span><span style="color:#616E88">// ç­‰å¾…æ¥æ”¶ çš„goroutineé˜Ÿåˆ—ï¼ˆå°è¯•ä»channelè¯»å–æ•°æ®è€Œå µå¡ï¼‰</span></span>
<span class="line"><span style="color:#D8DEE9">	sendq</span><span style="color:#D8DEE9FF">    waitq          </span><span style="color:#616E88">// ç­‰å¾…å‘é€ çš„goroutineé˜Ÿåˆ—ï¼ˆå°è¯•å‘é€æ•°æ®è‡³channelè€Œå µå¡ï¼‰</span></span>
<span class="line"><span style="color:#D8DEE9FF">	</span></span>
<span class="line"><span style="color:#D8DEE9">	lock</span><span style="color:#D8DEE9FF"> mutex              </span><span style="color:#616E88">// é”ä¿æŠ¤hchançš„æ‰€æœ‰å­—æ®µ</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// 2. makechan æºç ï¼šåˆ†é…hchanå¤§å°ã€åº•å±‚çš„å¾ªç¯é˜Ÿåˆ—(å¯èƒ½æ— )çš„å¤§å°</span></span>
<span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> makechan</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">t</span><span style="color:#81A1C1"> *</span><span style="color:#D8DEE9FF">chantype</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> size</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> *</span><span style="color:#D8DEE9FF">hchan </span><span style="color:#ECEFF4">{</span></span>
<span class="line"><span style="color:#616E88">	// 1. è·å–å…ƒç´ ç±»å‹</span></span>
<span class="line"><span style="color:#D8DEE9">	elem</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> t</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">Elem</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 2. è®¡ç®—å†…å­˜å¤§å°ï¼›åˆ¤æ–­æº¢å‡º</span></span>
<span class="line"><span style="color:#D8DEE9">	mem</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> overflow</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> math</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">MulUintptr</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">elem</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">Size_</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> uintptr</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">size</span><span style="color:#ECEFF4">))</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> overflow</span><span style="color:#81A1C1"> ||</span><span style="color:#D8DEE9"> mem</span><span style="color:#81A1C1"> ></span><span style="color:#D8DEE9"> maxAlloc</span><span style="color:#81A1C1">-</span><span style="color:#D8DEE9">hchanSize</span><span style="color:#81A1C1"> ||</span><span style="color:#D8DEE9"> size</span><span style="color:#81A1C1"> &#x3C;</span><span style="color:#B48EAD"> 0</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">		panic</span><span style="color:#ECEFF4">(</span><span style="color:#88C0D0">plainError</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">makechan: size out of range</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">))</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 3. å¼€å§‹åˆ†é…</span></span>
<span class="line"><span style="color:#81A1C1">	var</span><span style="color:#D8DEE9"> c</span><span style="color:#81A1C1"> *</span><span style="color:#D8DEE9FF">hchan</span></span>
<span class="line"><span style="color:#81A1C1">	switch</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#616E88">	// 3.1 åªåˆ†é…hchançš„å¤§å°</span></span>
<span class="line"><span style="color:#81A1C1">	case</span><span style="color:#D8DEE9"> mem</span><span style="color:#81A1C1"> ==</span><span style="color:#B48EAD"> 0</span><span style="color:#ECEFF4">:</span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#81A1C1"> =</span><span style="color:#ECEFF4"> (</span><span style="color:#81A1C1">*</span><span style="color:#D8DEE9FF">hchan</span><span style="color:#ECEFF4">)(</span><span style="color:#88C0D0">mallocgc</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">hchanSize</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> true</span><span style="color:#ECEFF4">))</span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">buf</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">raceaddr</span><span style="color:#ECEFF4">()</span></span>
<span class="line"><span style="color:#616E88">	// 3.2 æ— æŒ‡é’ˆï¼Œhchan å’Œ buf ä¸€èµ·åˆ†é…</span></span>
<span class="line"><span style="color:#81A1C1">	case</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">elem</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Pointers</span><span style="color:#ECEFF4">():</span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#81A1C1"> =</span><span style="color:#ECEFF4"> (</span><span style="color:#81A1C1">*</span><span style="color:#D8DEE9FF">hchan</span><span style="color:#ECEFF4">)(</span><span style="color:#88C0D0">mallocgc</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">hchanSize</span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9">mem</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> true</span><span style="color:#ECEFF4">))</span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">buf</span><span style="color:#81A1C1"> =</span><span style="color:#88C0D0"> add</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">unsafe</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Pointer</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">),</span><span style="color:#D8DEE9"> hchanSize</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#616E88">	// 3.4 æœ‰æŒ‡é’ˆï¼Œhchan å’Œ buf åˆ†å¼€åˆ†é…</span></span>
<span class="line"><span style="color:#81A1C1">	default</span><span style="color:#ECEFF4">:</span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#81A1C1"> =</span><span style="color:#88C0D0"> new</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">hchan</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">buf</span><span style="color:#81A1C1"> =</span><span style="color:#88C0D0"> mallocgc</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">mem</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> elem</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> true</span><span style="color:#ECEFF4">)</span><span style="color:#616E88"> // 2nd å‚æ•°ä¸ä¸ºnilï¼Œä¼šè¢«GCæ‰«æ(æ— ç±»å‹ä¿¡æ¯å°±ä¸ä¼šæ‰«æ)</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 4. è®¾ç½®ï¼šå…ƒç´ å¤§å°ã€å…ƒç´ ç±»å‹ã€å¾ªç¯é˜Ÿåˆ—å¤§å°</span></span>
<span class="line"><span style="color:#D8DEE9">	c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elemsize</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> uint16</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">elem</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">Size_</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#D8DEE9">	c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elemtype</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> elem</span></span>
<span class="line"><span style="color:#D8DEE9">	c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">dataqsiz</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> uint</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">size</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#81A1C1">	return</span><span style="color:#D8DEE9"> c</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span></code></pre>
<h3 id="132--å…³é—­">1.3.2 Â· å…³é—­</h3>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#D8DEE9">ch</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#88C0D0">close</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ch</span><span style="color:#ECEFF4">)</span></span></code></pre>
<p>æŸ¥çœ‹æ±‡ç¼–ï¼Œå¯çŸ¥å…³é—­chançš„å‡½æ•°æ˜¯runtime.closechanï¼›</p>
<p>æŸ¥çœ‹closechanæºç </p>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> closechan</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#81A1C1"> *</span><span style="color:#D8DEE9FF">hchan</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#616E88">	// 1. è®¾ç½®è¡¨ç¤ºå…³é—­çš„å­—æ®µ</span></span>
<span class="line"><span style="color:#D8DEE9">	c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">closed</span><span style="color:#81A1C1"> =</span><span style="color:#B48EAD"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">	var</span><span style="color:#D8DEE9"> glist</span><span style="color:#D8DEE9FF"> gList</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 2. é‡Šæ”¾æ‰€æœ‰é˜»å¡åœ¨è¯»å½“å‰chançš„goroutine</span></span>
<span class="line"><span style="color:#81A1C1">	for</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">		sg</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">recvq</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">dequeue</span><span style="color:#ECEFF4">()</span></span>
<span class="line"><span style="color:#616E88">		// 2.1 æœ‰æ¥å—å€¼ï¼Œç»™é›¶å€¼</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#D8DEE9"> sg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elem</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">get</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1"> !=</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">			typedmemclr</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elemtype</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> sg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elem</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">get</span><span style="color:#ECEFF4">())</span></span>
<span class="line"><span style="color:#D8DEE9">			sg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elem</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">nil</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#616E88">		// 2.2 å”¤é†’åï¼Œé€šè¿‡ gp.param å–å›è‡ªå·±çš„ sudog</span></span>
<span class="line"><span style="color:#D8DEE9">		gp</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> sg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">g</span></span>
<span class="line"><span style="color:#D8DEE9">		gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">param</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> unsafe</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Pointer</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">sg</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#D8DEE9">		sg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">success</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#D8DEE9">		glist</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">push</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">gp</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 3. é‡Šæ”¾æ‰€æœ‰é˜»å¡åœ¨å†™å½“å‰chançš„goroutine(ä¼španic)</span></span>
<span class="line"><span style="color:#81A1C1">	for</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">		sg</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">sendq</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">dequeue</span><span style="color:#ECEFF4">()</span></span>
<span class="line"><span style="color:#616E88">		// 3.1 æœ¬æ¬¡å‘é€ä½œåºŸ</span></span>
<span class="line"><span style="color:#D8DEE9">		sg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elem</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">nil</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#616E88">		// 3.2 å”¤é†’åï¼Œé€šè¿‡ gp.param å–å›è‡ªå·±çš„ sudog</span></span>
<span class="line"><span style="color:#D8DEE9">		gp</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> sg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">g</span></span>
<span class="line"><span style="color:#D8DEE9">		gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">param</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> unsafe</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Pointer</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">sg</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#D8DEE9">		sg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">success</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#D8DEE9">		glist</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">push</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">gp</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 4. å”¤é†’æ‰€æœ‰goroutine</span></span>
<span class="line"><span style="color:#81A1C1">	for</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">glist</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">empty</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">		gp</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> glist</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">pop</span><span style="color:#ECEFF4">()</span></span>
<span class="line"><span style="color:#88C0D0">		goready</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">gp</span><span style="color:#ECEFF4">,</span><span style="color:#B48EAD"> 3</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span></code></pre>
<p>NOTEï¼š</p>
<ol>
<li>å†…å»ºå‡½æ•° close(ch&#x3C;-)  å…³é—­ä¸€ä¸ªåŒå‘çš„æˆ–è€…åªå‘é€çš„channel</li>
<li>closeå‡½æ•°åº”è¯¥ç”±å‘é€æ–¹è°ƒç”¨ï¼Œè€Œä¸æ˜¯æ¥æ”¶æ–¹(å¦‚æœæ˜¯æ¥æ”¶æ–¹å…³é—­ï¼Œåˆ™å‘é€æ–¹ä¼španicï¼›ååˆ™æ¥æ”¶æ–¹åªä¼šæ”¶åˆ°é›¶å€¼)</li>
<li>ä»ä¸€ä¸ªå…³é—­çš„channelè·å–å€¼ï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œè·å–çš„å€¼æ˜¯channelå…ƒç´ çš„é›¶å€¼ï¼Œå¯ä»¥ä½¿ç”¨<code>x, ok := &#x3C;-ch</code>çš„okåˆ¤æ–­channelæ˜¯å¦å…³é—­ã€‚</li>
<li>åœ¨channelçš„æœ€åä¸€ä¸ªå€¼è¢«æ¥æ”¶åï¼Œå…³é—­channel ( defer close(ch) )</li>
</ol>
<p>åº”ç”¨ï¼š
ç”±äºä»ä¸€ä¸ªå·²ç»å…³é—­çš„channelä¸­è·å–å€¼ä¸ä¼šè¢«é˜»å¡ï¼Œè‹¥æŸäº›åç¨‹ä¸­é˜»å¡åœ¨æ¥æ”¶ä¸€ä¸ªchannelçš„å€¼çš„æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨closeå‡½æ•°æ¥å…³é—­è¯¥channelï¼Œè¿™äº›é˜»å¡çš„åç¨‹å°†ä¸å†é˜»å¡ã€‚</p>
<h3 id="133--å‘é€æ¥å—">1.3.3 Â· å‘é€/æ¥å—</h3>
<p>éç¼“å†²ï¼šruntime åœ¨â€™å‘é€ Gâ€™å’Œâ€™æ¥æ”¶ Gâ€™ä¹‹é—´ç›´æ¥ä¼ å€¼
ç¼“å†²ï¼šå¹³æ—¶ä»ç¼“å†²åŒºæ‹¿/æ”¾ï¼Œå¿…è¦æ—¶ä»æ˜¯ G å¯¹ G</p>
<p>æ€»ç»“å‘é€/æ¥å—æ“ä½œï¼š</p>
<ol>
<li>éé˜»å¡æ“ä½œæ—¶ï¼Œä¹Ÿå°±æ˜¯selectæ—¶ï¼Œchanä¸ºnilæˆ–è€…å¯¹åº”å†™/è¯»ä¸ºæ»¡/ç©ºï¼Œéƒ½æ˜¯ç›´æ¥è¿”å›</li>
<li>é˜»å¡æ“ä½œæ—¶å€™ï¼Œchanä¸ºnilæˆ–è€…ä¸ºæ»¡/ç©ºï¼Œæ»¡å‘é€é˜»å¡ï¼Œç©ºæ¥æ”¶é˜»å¡ï¼</li>
<li>é˜»å¡æ“ä½œï¼Œä¸”chanä¸ºclosedæ—¶ï¼Œå‘é€panicï¼Œè¯»è·å–é›¶å€¼</li>
<li>é˜»å¡ï¼Œchanä¸ä¸ºæ»¡/ç©ºä¸”æœªcloseï¼Œä¸”å†™æ“ä½œæœ‰å¯¹åº”çš„è¯»é˜»å¡ï¼›è¯»æ“ä½œæœ‰å¯¹åº”çš„å†™é˜»å¡ï¼Œç›´æ¥ä¼ é€’å€¼</li>
<li>é˜»å¡ï¼Œchanä¸ä¸ºæ»¡/ç©ºä¸”æœªcloseï¼Œå†™æ“ä½œæŠŠå€¼æ”¾å…¥ç¼“å­˜åŒºï¼Œè¯»æ“ä½œä»ç¼“å­˜åŒºæ‹¿å€¼</li>
<li>é˜»å¡çš„è¯»/å†™æ“ä½œï¼Œä¼šè¢«å¯¹åº”çš„å¦ä¸€ä¸ªæ“ä½œå”¤é†’ï¼Œå¯¹åº”ç¬¬4æ­¥ï¼Œç›´æ¥è·å–å€¼ï¼Œä½†å¦‚æœæ˜¯è¢«closeå”¤é†’ï¼Œåˆ™å‘é€panicï¼Œè¯»å–è·å¾—é›¶å€¼</li>
</ol>
<h4 id="1331--å‘é€">1.3.3.1 Â· å‘é€</h4>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#D8DEE9">ch</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#D8DEE9">ch</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#B48EAD"> 1</span></span></code></pre>
<p>æŸ¥çœ‹æ±‡ç¼–ï¼Œå¯çŸ¥å¾€chanå‘é€æ•°æ®çš„å‡½æ•°æ˜¯runtime.chansendï¼›</p>
<p>æŸ¥çœ‹chansendæºç </p>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> chansend</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#81A1C1"> *</span><span style="color:#D8DEE9FF">hchan</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ep</span><span style="color:#D8DEE9FF"> unsafe</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">Pointer</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> block</span><span style="color:#81A1C1"> bool</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> callerpc</span><span style="color:#81A1C1"> uintptr</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> bool</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#616E88">	// 1. å¦‚æœchannelæ˜¯nilï¼šéé˜»å¡(selectä¸­)åˆ™ç›´æ¥è¿”å›ï¼Œé˜»å¡åˆ™æŒ‚èµ·å½“å‰goroutine</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> c</span><span style="color:#81A1C1"> ==</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">block</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">			return</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#88C0D0">		gopark</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">nil</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> waitReasonChanSendNilChan</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> traceBlockForever</span><span style="color:#ECEFF4">,</span><span style="color:#B48EAD"> 2</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#88C0D0">		throw</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">unreachable</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 2. ä¾æ—§selectä¸­ï¼Œå¾€æ»¡chanä¸­å†™</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">block</span><span style="color:#81A1C1"> &#x26;&#x26;</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">closed</span><span style="color:#81A1C1"> ==</span><span style="color:#B48EAD"> 0</span><span style="color:#81A1C1"> &#x26;&#x26;</span><span style="color:#88C0D0"> full</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">		return</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 3. å¾€å…³é—­çš„chanå†™ï¼Œpanic</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">closed</span><span style="color:#81A1C1"> !=</span><span style="color:#B48EAD"> 0</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">		panic</span><span style="color:#ECEFF4">(</span><span style="color:#88C0D0">plainError</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">send on closed channel</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">))</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 4. æœ‰é˜»å¡åœ¨è¯»å½“å‰chançš„åç¨‹ï¼Œç›´æ¥ä¼ é€’å€¼ç»™å®ƒï¼Œä¸ç»è¿‡ç¼“å­˜åŒº</span></span>
<span class="line"><span style="color:#616E88">	// eq å³è¦å‘é€çš„å€¼</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> sg</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">recvq</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">dequeue</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9"> sg</span><span style="color:#81A1C1"> !=</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">		send</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> sg</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ep</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> func</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span><span style="color:#88C0D0"> unlock</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">lock</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> },</span><span style="color:#B48EAD"> 3</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#81A1C1">		return</span><span style="color:#81A1C1"> true</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 4. ç¼“å­˜åŒºæœ‰ç©ºé—´ï¼šå°†è¦å‘é€çš„å€¼å…¥é˜Ÿåˆ—ï¼ˆå¹¶æ— é˜»å¡è¯»æ–¹éœ€è¦å”¤é†’ï¼‰</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">qcount</span><span style="color:#81A1C1"> &#x3C;</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">dataqsiz</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">		qp</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> chanbuf</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">sendx</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#88C0D0">		typedmemmove</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elemtype</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> qp</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ep</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">sendx</span><span style="color:#81A1C1">++</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">sendx</span><span style="color:#81A1C1"> ==</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">dataqsiz</span><span style="color:#ECEFF4"> {</span><span style="color:#616E88"> // é‡ç½®ç´¢å¼•</span></span>
<span class="line"><span style="color:#D8DEE9">			c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">sendx</span><span style="color:#81A1C1"> =</span><span style="color:#B48EAD"> 0</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">qcount</span><span style="color:#81A1C1">++</span></span>
<span class="line"><span style="color:#81A1C1">		return</span><span style="color:#81A1C1"> true</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 5. åç»­ä¸€å®šæ˜¯é˜»å¡æ“ä½œäº†ï¼ˆéselectï¼‰ï¼Œéœ€è¦æŠŠå½“å‰ g æŒ‚èµ·æ¥äº†</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">block</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">		return</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> getg</span><span style="color:#ECEFF4">()</span></span>
<span class="line"><span style="color:#616E88">	// 5.1 æ„å»ºä¼ªgoroutine</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> acquireSudog</span><span style="color:#ECEFF4">()</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elem</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ep</span><span style="color:#ECEFF4">)</span><span style="color:#616E88"> // 5.2 è®¾ç½®å€¼</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">waitlink</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> nil</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">g</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> gp</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">isSelect</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">waiting</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> mysg</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">param</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> nil</span></span>
<span class="line"><span style="color:#616E88">	// 5.2 å…¥ chan çš„é˜»å¡å†™é˜Ÿåˆ—</span></span>
<span class="line"><span style="color:#D8DEE9">	c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">sendq</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">enqueue</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">mysg</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span></span>
<span class="line"><span style="color:#616E88">	// 5.3 é˜»å¡å½“å‰gï¼ŒæŒ‚èµ·</span></span>
<span class="line"><span style="color:#D8DEE9">	reason</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> waitReasonChanSend</span></span>
<span class="line"><span style="color:#88C0D0">	gopark</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">chanparkcommit</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> unsafe</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Pointer</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">lock</span><span style="color:#ECEFF4">),</span><span style="color:#D8DEE9"> reason</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> traceBlockChanSend</span><span style="color:#ECEFF4">,</span><span style="color:#B48EAD"> 2</span><span style="color:#ECEFF4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// é˜»å¡åœ¨è¿™é‡Œ........</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 5.4 è¢«å”¤é†’ï¼šä¸¤è€…å¯èƒ½ 1) è¯»æ–¹æ‹¿æ‰äº†å€¼ 2) chanè¢«closeäº†</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">waiting</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> nil</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">activeStackChans</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#D8DEE9">	closed</span><span style="color:#81A1C1"> :=</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">success</span><span style="color:#616E88"> // å‘é€æœªæˆåŠŸï¼Œè¡¨ç¤ºchanè¢«å…³äº†</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">param</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> nil</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">nil</span><span style="color:#ECEFF4">)</span><span style="color:#616E88"> // å€¼è¢«æ¶ˆè´¹æ‰äº†</span></span>
<span class="line"><span style="color:#88C0D0">	releaseSudog</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">mysg</span><span style="color:#ECEFF4">)</span><span style="color:#616E88"> // é‡Šæ”¾ä¼ªg</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> closed</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">		panic</span><span style="color:#ECEFF4">(</span><span style="color:#88C0D0">plainError</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">send on closed channel</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">))</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"><span style="color:#81A1C1">	return</span><span style="color:#81A1C1"> true</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span></code></pre>
<p>æ€»ç»“å‘é€æ“ä½œï¼š</p>
<ol>
<li>éé˜»å¡éƒ¨åˆ†çš„é€»è¾‘ï¼ˆselectç›¸å…³ï¼‰ï¼šä¸ºnil/æ»¡äº†(æœªå…³é—­)ï¼Œåˆ™ç›´æ¥è¿”å›ï¼›</li>
<li>æœ‰è¯»æ“ä½œé˜»å¡ï¼Œç›´æ¥æŠŠå€¼ç»™å®ƒ</li>
<li>ç¼“å­˜åŒºæœ‰ç©ºé—´ï¼Œæ”¾å…¥ç¼“å­˜åŒº</li>
<li>æ— ç©ºé—´ï¼Œè¡¨ç¤ºé˜»å¡äº†ï¼Œæ„å»ºä¼ªgï¼ˆå€¼å­˜è¿™é‡Œï¼‰ï¼Œ<a href="/notes/1770786730-PFOI#gopark">æŒ‚è½½åˆ°chanä¸Š</a></li>
<li>ç­‰å”¤é†’ï¼šè¯»æ“ä½œæˆ–å…³é—­chanå”¤é†’ï¼ˆä¼ªgèµ„æºé‡Šæ”¾ã€å…³é—­chanå”¤é†’éœ€è¦panicï¼‰</li>
</ol>
<p>NOTE: å‘é€åˆ°nilçš„chanï¼ŒæŒ‚èµ·ï¼ˆselectåˆ™ä¸æŒ‚èµ·ï¼‰ï¼›å‘é€åˆ°closedçš„chanï¼Œpanicï¼ˆselectçš„ä¹Ÿpanicï¼‰</p>
<h4 id="1332--æ¥æ”¶">1.3.3.2 Â· æ¥æ”¶</h4>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#D8DEE9">ch</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#D8DEE9">val</span><span style="color:#81A1C1"> :=</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9"> ch</span></span>
<span class="line"><span style="color:#616E88">// æˆ–è€…</span></span>
<span class="line"><span style="color:#D8DEE9">val</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ok</span><span style="color:#81A1C1"> :=</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9"> ch</span></span></code></pre>
<p>åˆ†æ˜¯å¦å¸¦okä¸¤ç§ï¼ŒæŸ¥çœ‹æ±‡ç¼–ï¼Œå¯çŸ¥å¾€chanå‘é€æ•°æ®çš„å‡½æ•°æ˜¯<code>runtime.chanrecv1</code>æˆ–<code>runtime.chanrecv2</code>ï¼Œæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨<code>runtime.chanrecv</code></p>
<p>æŸ¥çœ‹chanrecvæºç </p>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> chanrecv</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#81A1C1"> *</span><span style="color:#D8DEE9FF">hchan</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ep</span><span style="color:#D8DEE9FF"> unsafe</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">Pointer</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> block</span><span style="color:#81A1C1"> bool</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> (</span><span style="color:#D8DEE9">selected</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> received</span><span style="color:#81A1C1"> bool</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#616E88">	// raceenabled: don't need to check ep, as it is always on the stack</span></span>
<span class="line"><span style="color:#616E88">	// or is new memory allocated by reflect.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> debugChan</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">		print</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">chanrecv: chan=</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">,</span><span style="color:#ECEFF4"> "</span><span style="color:#EBCB8B">\n</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 1. ä»ä¸é˜»å¡çš„chanè¯»(select)åˆ™ç›´æ¥è¿”å›ï¼›å¦åˆ™æŒ‚èµ·</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> c</span><span style="color:#81A1C1"> ==</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">block</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">			return</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#88C0D0">		gopark</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">nil</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> waitReasonChanReceiveNilChan</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> traceBlockForever</span><span style="color:#ECEFF4">,</span><span style="color:#B48EAD"> 2</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#88C0D0">		throw</span><span style="color:#ECEFF4">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">unreachable</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 2. å¿«é€Ÿè·¯å¾„ï¼ˆä¸é˜»å¡ï¼Œä¸”ä¸ºç©ºï¼‰ï¼š</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">block</span><span style="color:#81A1C1"> &#x26;&#x26;</span><span style="color:#88C0D0"> empty</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#616E88">		// 2.1 æœªå…³é—­ï¼Œç›´æ¥è¿”å›</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#D8DEE9"> atomic</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Load</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">closed</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> ==</span><span style="color:#B48EAD"> 0</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">			return</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#616E88">		// 2.2 å·²ç»å…³é—­ä¸”ä¸ºç©ºï¼Œè¿”å›é›¶å€¼</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#88C0D0"> empty</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">			if</span><span style="color:#D8DEE9"> ep</span><span style="color:#81A1C1"> !=</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">				typedmemclr</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elemtype</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ep</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">			}</span></span>
<span class="line"><span style="color:#81A1C1">			return</span><span style="color:#81A1C1"> true</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 3. å·²ç»å…³é—­</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">closed</span><span style="color:#81A1C1"> !=</span><span style="color:#B48EAD"> 0</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#616E88">		// 3.1 ç¯å½¢é˜Ÿåˆ—é‡Œé¢ä¹Ÿæ²¡å€¼äº†ï¼Œè¿”å›é›¶å€¼</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">qcount</span><span style="color:#81A1C1"> ==</span><span style="color:#B48EAD"> 0</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">			if</span><span style="color:#D8DEE9"> ep</span><span style="color:#81A1C1"> !=</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">				typedmemclr</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elemtype</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ep</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">			}</span></span>
<span class="line"><span style="color:#81A1C1">			return</span><span style="color:#81A1C1"> true</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span><span style="color:#81A1C1"> else</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#616E88">		// 3.2 æœªå…³é—­ï¼Œä¸”å½“å‰chanæœ‰é˜»å¡å†™ï¼Œç›´æ¥è·å–å€¼å¹¶è¿”å›</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#D8DEE9"> sg</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">sendq</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">dequeue</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9"> sg</span><span style="color:#81A1C1"> !=</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">			recv</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> sg</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ep</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> func</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span><span style="color:#88C0D0"> unlock</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">lock</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> },</span><span style="color:#B48EAD"> 3</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#81A1C1">			return</span><span style="color:#81A1C1"> true</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> true</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 4. æœªå…³é—­ï¼Œä¸”å½“å‰chanæ— é˜»å¡å†™</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">qcount</span><span style="color:#81A1C1"> ></span><span style="color:#B48EAD"> 0</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#616E88">		// è·å–ç¼“å­˜åŒºçš„å…ƒç´ </span></span>
<span class="line"><span style="color:#D8DEE9">		qp</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> chanbuf</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">recvx</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#616E88">		// èµ‹å€¼åˆ°æ¥å—å€¼</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#D8DEE9"> ep</span><span style="color:#81A1C1"> !=</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#88C0D0">			typedmemmove</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elemtype</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ep</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> qp</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#88C0D0">		typedmemclr</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elemtype</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> qp</span><span style="color:#ECEFF4">)</span><span style="color:#616E88"> // æ¸…ç©ºç¼“å†²åŒºçš„å€¼</span></span>
<span class="line"><span style="color:#616E88">		// ç´¢å¼•æ•°æ®çš„è°ƒæ•´</span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">recvx</span><span style="color:#81A1C1">++</span></span>
<span class="line"><span style="color:#81A1C1">		if</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">recvx</span><span style="color:#81A1C1"> ==</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">dataqsiz</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">			c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">recvx</span><span style="color:#81A1C1"> =</span><span style="color:#B48EAD"> 0</span></span>
<span class="line"><span style="color:#ECEFF4">		}</span></span>
<span class="line"><span style="color:#D8DEE9">		c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">qcount</span><span style="color:#81A1C1">--</span></span>
<span class="line"><span style="color:#81A1C1">		return</span><span style="color:#81A1C1"> true</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> true</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">block</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#616E88">		// 5. åç»­éƒ½æ˜¯é˜»å¡æ“ä½œäº†</span></span>
<span class="line"><span style="color:#81A1C1">		return</span><span style="color:#81A1C1"> false</span><span style="color:#ECEFF4">,</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> getg</span><span style="color:#ECEFF4">()</span></span>
<span class="line"><span style="color:#616E88">	// 5.1 æ„å»ºä¼ªg</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> acquireSudog</span><span style="color:#ECEFF4">()</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">releasetime</span><span style="color:#81A1C1"> =</span><span style="color:#B48EAD"> 0</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">elem</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ep</span><span style="color:#ECEFF4">)</span><span style="color:#616E88"> // è®¾ç½®å€¼</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">waitlink</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> nil</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">waiting</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> mysg</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">g</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> gp</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">isSelect</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">param</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> nil</span></span>
<span class="line"><span style="color:#616E88">	// 5.2 ä¼ªgå…¥chan</span></span>
<span class="line"><span style="color:#D8DEE9">	c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">recvq</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">enqueue</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">mysg</span><span style="color:#ECEFF4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 5.3 é˜»å¡å½“å‰g</span></span>
<span class="line"><span style="color:#D8DEE9">	reason</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> waitReasonChanReceive</span></span>
<span class="line"><span style="color:#81A1C1">	if</span><span style="color:#D8DEE9"> c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">bubble</span><span style="color:#81A1C1"> !=</span><span style="color:#81A1C1"> nil</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">		reason</span><span style="color:#81A1C1"> =</span><span style="color:#D8DEE9"> waitReasonSynctestChanReceive</span></span>
<span class="line"><span style="color:#ECEFF4">	}</span></span>
<span class="line"><span style="color:#88C0D0">	gopark</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">chanparkcommit</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> unsafe</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Pointer</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">&#x26;</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">lock</span><span style="color:#ECEFF4">),</span><span style="color:#D8DEE9"> reason</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> traceBlockChanRecv</span><span style="color:#ECEFF4">,</span><span style="color:#B48EAD"> 2</span><span style="color:#ECEFF4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// é˜»å¡åœ¨è¿™é‡Œ.......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">	// 6. è¢«å”¤é†’ï¼šå¯¹chanæœ‰å†™æ“ä½œï¼Œæˆ–è¢«close</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">waiting</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> nil</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">activeStackChans</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> false</span></span>
<span class="line"><span style="color:#D8DEE9">	success</span><span style="color:#81A1C1"> :=</span><span style="color:#D8DEE9"> mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">success</span></span>
<span class="line"><span style="color:#D8DEE9">	gp</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">param</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> nil</span></span>
<span class="line"><span style="color:#D8DEE9">	mysg</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">c</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">nil</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#88C0D0">	releaseSudog</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">mysg</span><span style="color:#ECEFF4">)</span><span style="color:#616E88"> // é‡Šæ”¾ä¼ªg</span></span>
<span class="line"><span style="color:#81A1C1">	return</span><span style="color:#81A1C1"> true</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> success</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span></code></pre>
<p>æ€»ç»“æ¥æ”¶æ“ä½œï¼š</p>
<ol>
<li>ä¸é˜»å¡ä¹Ÿå°±æ˜¯selectä¸­ï¼Œä¸ºnilæˆ–ä¸ºç©ºï¼Œç›´æ¥æ”¾å›ï¼›å’Œå‘é€ç±»ä¼¼ï¼Œä¸ºnilæˆ–è€…æ»¡äº†ï¼Œç›´æ¥è¿”å›</li>
<li>closeäº†ä¸”ä¸ºç©ºï¼Œåˆ™è¿”å›é›¶å€¼ï¼Œè¿™é‡Œå’Œå‘é€ä¸ä¸€æ ·ï¼Œå¾€closeé‡Œé¢å‘ä¼španic</li>
<li>ä¸ä¸ºç©ºï¼Œæœ‰é˜»å¡å†™ï¼Œåˆ™æ¥å—å€¼åè¿”å›</li>
<li>ç¼“å­˜åŒºæœ‰å€¼ï¼Œç›´æ¥æ‹¿</li>
<li>æ— å€¼ï¼Œ<a href="/notes/1770786730-PFOI#gopark">é˜»å¡</a>ï¼Œç›´åˆ°æœ‰å†™æ“ä½œæˆ–è€…è¢«close</li>
</ol>
<h2 id="14--patterns">1.4 Â· Patterns</h2>
<h3 id="141--1-or-done-æ¨¡å¼">1.4.1 Â· 1. Or-Done æ¨¡å¼</h3>
<p>åœºæ™¯ï¼šå¤šä¸ª goroutine å„è‡ªå¹²æ´»ï¼ˆå¯èƒ½åšä¸åŒäº‹ï¼‰ï¼Œè°å…ˆå®Œæˆå°±å…³ doneï¼ˆæˆ– cancel contextï¼‰ï¼Œå…¶ä»– goroutine é€šè¿‡ select å‘ç°åæå‰é€€å‡ºã€‚</p>
<p>ç›®çš„ï¼šç«é€Ÿ / å–â€œç¬¬ä¸€ä¸ªç»“æœâ€ï¼Œå¹¶å–æ¶ˆè¿˜æ²¡å®Œæˆçš„ä»»åŠ¡ï¼ŒèŠ‚çœèµ„æºã€‚</p>
<p>å…¸å‹å†™æ³•ï¼š
done := make(chan struct{})ï¼Œå…ˆå®Œæˆçš„ goroutine é‡Œ close(done)ï¼Œå…¶ä»– goroutine é‡Œ select { case &#x3C;-done: return; case â€¦ }ã€‚
è¿™æ˜¯â€œå¤šè·¯ç«é€Ÿï¼Œå…ˆåˆ°è€…èƒœï¼Œå…¶ä½™æ”¶å·¥â€çš„ç¼–æ’ã€‚</p>
<h3 id="142--2-æ‰‡å…¥æ¨¡å¼-fan-in">1.4.2 Â· 2. æ‰‡å…¥æ¨¡å¼ (Fan-In)</h3>
<p>å¤šä¸ªè¾“å…¥ channelï¼Œä¸€ä¸ªè¾“å‡º channelã€‚å°†å¤šä¸ªæº channel çš„æ•°æ®åˆå¹¶åˆ°ä¸€ä¸ªç›®çš„ channelã€‚</p>
<p>æ–¹æ³•ï¼šä½¿ç”¨selectç›‘å¬å¤šä¸ªchanï¼Œæˆ–è€…ä½¿ç”¨waitgroupå¼€å¯å¤šä¸ªåç¨‹å¾€chanå†…å†™</p>
<h3 id="143--3-æ‰‡å‡ºæ¨¡å¼-fan-out">1.4.3 Â· 3. æ‰‡å‡ºæ¨¡å¼ (Fan-Out)</h3>
<p>ä¸€ä¸ªè¾“å…¥ channelï¼Œå¤šä¸ªè¾“å‡º channelã€‚å°†ä¸€ä¸ªæº channel çš„æ•°æ®åˆ†å‘åˆ°å¤šä¸ªç›®çš„ channelã€‚</p>
<p>æ–¹æ³•ï¼šå¼€å¯å¤šä¸ªåç¨‹ä»chanè¯»</p>
<h3 id="144--4-stream-æ¨¡å¼">1.4.4 Â· 4. Stream æ¨¡å¼</h3>
<p>æŠŠ channel çœ‹ä½œæ•°æ®æµï¼Œæä¾› mapã€filterã€take ç­‰æ“ä½œã€‚</p>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#616E88">// takeï¼šåªå–å‰ n ä¸ªå…ƒç´ </span></span>
<span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> take</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ctx</span><span style="color:#D8DEE9FF"> context</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">Context</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> in</span><span style="color:#81A1C1"> &#x3C;-chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> n</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> &#x3C;-chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">    out</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#81A1C1">    go</span><span style="color:#81A1C1"> func</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">        defer</span><span style="color:#88C0D0"> close</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">out</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#81A1C1">        for</span><span style="color:#D8DEE9"> i</span><span style="color:#81A1C1"> :=</span><span style="color:#B48EAD"> 0</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9"> i</span><span style="color:#81A1C1"> &#x3C;</span><span style="color:#D8DEE9"> n</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9"> i</span><span style="color:#81A1C1">++</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">            select</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">            case</span><span style="color:#D8DEE9"> val</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> ok</span><span style="color:#81A1C1"> :=</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9">in</span><span style="color:#ECEFF4">:</span></span>
<span class="line"><span style="color:#81A1C1">                if</span><span style="color:#81A1C1"> !</span><span style="color:#D8DEE9">ok</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">                    return</span></span>
<span class="line"><span style="color:#ECEFF4">                }</span></span>
<span class="line"><span style="color:#D8DEE9">                out</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9"> val</span></span>
<span class="line"><span style="color:#81A1C1">            case</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9">ctx</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Done</span><span style="color:#ECEFF4">():</span></span>
<span class="line"><span style="color:#81A1C1">                return</span></span>
<span class="line"><span style="color:#ECEFF4">            }</span></span>
<span class="line"><span style="color:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#ECEFF4">    }()</span></span>
<span class="line"><span style="color:#81A1C1">    return</span><span style="color:#D8DEE9"> out</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// mapï¼šæ˜ å°„è½¬æ¢</span></span>
<span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> streamMap</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ctx</span><span style="color:#D8DEE9FF"> context</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">Context</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> in</span><span style="color:#81A1C1"> &#x3C;-chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> f</span><span style="color:#81A1C1"> func</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">int</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> &#x3C;-chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">    out</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#81A1C1">    go</span><span style="color:#81A1C1"> func</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">        defer</span><span style="color:#88C0D0"> close</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">out</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#81A1C1">        for</span><span style="color:#D8DEE9"> val</span><span style="color:#81A1C1"> :=</span><span style="color:#81A1C1"> range</span><span style="color:#D8DEE9"> in</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">            select</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">            case</span><span style="color:#D8DEE9"> out</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#88C0D0"> f</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">val</span><span style="color:#ECEFF4">):</span></span>
<span class="line"><span style="color:#81A1C1">            case</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9">ctx</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Done</span><span style="color:#ECEFF4">():</span></span>
<span class="line"><span style="color:#81A1C1">                return</span></span>
<span class="line"><span style="color:#ECEFF4">            }</span></span>
<span class="line"><span style="color:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#ECEFF4">    }()</span></span>
<span class="line"><span style="color:#81A1C1">    return</span><span style="color:#D8DEE9"> out</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// filterï¼šè¿‡æ»¤</span></span>
<span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> filter</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">ctx</span><span style="color:#D8DEE9FF"> context</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">Context</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> in</span><span style="color:#81A1C1"> &#x3C;-chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> f</span><span style="color:#81A1C1"> func</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">int</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> bool</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1"> &#x3C;-chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#D8DEE9">    out</span><span style="color:#81A1C1"> :=</span><span style="color:#88C0D0"> make</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">chan</span><span style="color:#81A1C1"> int</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#81A1C1">    go</span><span style="color:#81A1C1"> func</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">        defer</span><span style="color:#88C0D0"> close</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">out</span><span style="color:#ECEFF4">)</span></span>
<span class="line"><span style="color:#81A1C1">        for</span><span style="color:#D8DEE9"> val</span><span style="color:#81A1C1"> :=</span><span style="color:#81A1C1"> range</span><span style="color:#D8DEE9"> in</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">            if</span><span style="color:#88C0D0"> f</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">val</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">                select</span><span style="color:#ECEFF4"> {</span></span>
<span class="line"><span style="color:#81A1C1">                case</span><span style="color:#D8DEE9"> out</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9"> val</span><span style="color:#ECEFF4">:</span></span>
<span class="line"><span style="color:#81A1C1">                case</span><span style="color:#81A1C1"> &#x3C;-</span><span style="color:#D8DEE9">ctx</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">Done</span><span style="color:#ECEFF4">():</span></span>
<span class="line"><span style="color:#81A1C1">                    return</span></span>
<span class="line"><span style="color:#ECEFF4">                }</span></span>
<span class="line"><span style="color:#ECEFF4">            }</span></span>
<span class="line"><span style="color:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#ECEFF4">    }()</span></span>
<span class="line"><span style="color:#81A1C1">    return</span><span style="color:#D8DEE9"> out</span></span>
<span class="line"><span style="color:#ECEFF4">}</span></span></code></pre>
<h2 id="15--æ€è€ƒ">1.5 Â· æ€è€ƒ</h2>
<p>Do not communicate by sharing memory; instead, share memory by communicating.
ç¿»è¯‘ï¼šä¸è¦é€šè¿‡åˆ†äº«å†…å­˜è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡é€šä¿¡è¿›è¡Œåˆ†äº«å†…å­˜ã€‚</p>
<p>ç†è§£ï¼š
communicateæ˜¯å¤šä¸ªç¨‹åºä¹‹é—´è¿›è¡Œé€šä¿¡ï¼›
sharing memoryæ˜¯åˆ†äº«ä¸€å—å†…å­˜çš„ä¿¡æ¯ï¼›
å‰åŠå¥ä¸­ï¼Œé€šè¿‡åˆ†äº«å†…å­˜ï¼Œä»è€Œè¿›è¡Œé€šä¿¡ï¼›ç›®çš„æ˜¯é€šä¿¡ï¼Œæ–¹æ³•æ˜¯åˆ†äº«å†…å­˜ï¼›ä¸¾ä¸ªä¾‹å­ï¼Œå¤šä¸ªäººä¹‹é—´ï¼Œå…±ç”¨ä¸€ä¸ªå†…å­˜å—ï¼Œåˆ©ç”¨è¿™ä¸€ä¸ªå†…å­˜å—ï¼Œè¿›è¡Œé€šä¿¡ï¼›
ååŠå¥ä¸­ï¼Œé€šè¿‡é€šä¿¡ï¼Œä»è€Œåˆ†äº«å†…å­˜ï¼›ç›®çš„æ˜¯åˆ†äº«å†…å­˜ï¼Œæ–¹æ³•æ˜¯é€šä¿¡ï¼›ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘æƒ³çŸ¥é“è¿™ä¸ªå†…å­˜å—çš„ä¿¡æ¯ï¼ˆåˆ†äº«ï¼‰ï¼Œä½¿ç”¨é€šä¿¡ï¼ˆchannelï¼‰çš„æ–¹å¼å¤åˆ¶è¿™ä¸ªå—çš„ä¿¡æ¯ï¼Œä»è€Œè¾¾åˆ°åˆ†äº«å†…å­˜ä¿¡æ¯çš„ç›®çš„ï¼›</p>
<p>æ³¨æ„ï¼šgoæ˜¯å€¼ä¼ é€’</p>
<p>åœºæ™¯ï¼š</p>
<ol>
<li><strong>å…±äº«èµ„æº</strong>çš„å¹¶å‘è®¿é—®ä½¿ç”¨ä¼ ç»Ÿå¹¶å‘åŸè¯­ï¼›</li>
<li>å¤æ‚çš„<strong>ä»»åŠ¡ç¼–æ’</strong>å’Œ<strong>æ¶ˆæ¯ä¼ é€’</strong>ä½¿ç”¨ Channelï¼›</li>
<li><strong>æ¶ˆæ¯é€šçŸ¥</strong>æœºåˆ¶ä½¿ç”¨ Channelï¼Œé™¤éåªæƒ³ signal ä¸€ä¸ª goroutineï¼Œæ‰ä½¿ç”¨ Condï¼›</li>
<li>ç®€å•ç­‰å¾…æ‰€æœ‰ä»»åŠ¡çš„å®Œæˆç”¨ WaitGroupï¼Œä¹Ÿæœ‰ Channel çš„æ¨å´‡è€…ç”¨ Channelï¼Œéƒ½å¯ä»¥ï¼›</li>
<li>éœ€è¦å’Œ Select è¯­å¥ç»“åˆï¼Œä½¿ç”¨ Channelï¼›</li>
<li>éœ€è¦å’Œè¶…æ—¶é…åˆæ—¶ï¼Œä½¿ç”¨ Channel å’Œ Contextã€‚</li>
</ol>
<h2 id="16--links">1.6 Â· links</h2>
<ol>
<li><a href="https://dave.cheney.net/2014/03/19/channel-axioms">Channel Axioms</a></li>
<li><a href="https://go.dev/blog/pipelines">Go Concurrency Patterns: Pipelines and cancellation</a></li>
</ol> <div class="mt-8 pt-8 border-t border-nord-4 dark:border-nord-2"> <details class="group cursor-pointer"> <summary class="btn-primary list-none"> <svg class="w-5 h-5 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M9 5l7 7-7 7"></path> </svg> <span>Local Knowledge Graph</span> </summary> <div class="mt-4"> <div id="local-graph-1770123038-CJXA" style="height: 400px;" class="knowledge-graph-container" data-astro-cid-zjb43jqo> <div class="knowledge-graph-wrapper" data-astro-cid-zjb43jqo> <svg id="local-graph-1770123038-CJXA-svg" style="width: 100%; height: 100%;" data-astro-cid-zjb43jqo></svg> </div> </div>  <script>(function(){const containerId = "local-graph-1770123038-CJXA";
const nodeRadius = 4;
const showLabels = true;
const enableZoom = true;
const enableDrag = true;
const dataJson = "{\"nodes\":[{\"id\":\"1770123038-CJXA\",\"urlId\":\"1770123038-CJXA\",\"label\":\"Go: channel é€šé“\",\"title\":\"Go: channel é€šé“\",\"group\":\"default\",\"nodeType\":\"current\"},{\"id\":\"1770786730-PFOI\",\"urlId\":\"1770786730-PFOI\",\"label\":\"Go: goroutine åç¨‹\",\"title\":\"Go: goroutine åç¨‹\",\"group\":\"default\",\"nodeType\":\"outlink\"},{\"id\":\"1770123038-RTOD\",\"urlId\":\"1770123038-RTOD\",\"label\":\"Go: compile ç¼–è¯‘å™¨\",\"title\":\"Go: compile ç¼–è¯‘å™¨\",\"group\":\"default\",\"nodeType\":\"outlink\"},{\"id\":\"1770123039-URZR\",\"urlId\":\"1770123039-URZR\",\"label\":\"scheduler\",\"title\":\"scheduler\",\"group\":\"default\",\"nodeType\":\"neighbor\"}],\"links\":[{\"source\":\"1770123038-CJXA\",\"target\":\"1770786730-PFOI\"},{\"source\":\"1770123038-CJXA\",\"target\":\"1770123038-RTOD\"},{\"source\":\"1770786730-PFOI\",\"target\":\"1770123039-URZR\"}]}";

  (window.__KNOWLEDGE_GRAPH_QUEUE__ = window.__KNOWLEDGE_GRAPH_QUEUE__ || []).push({
    containerId,
    dataJson,
    nodeRadius,
    showLabels,
    enableZoom,
    enableDrag,
  });
})();</script> </div> </details> </div><!-- Diagrams rendered at build time -->  </article> <nav class="mt-12 pt-8 border-t border-nord-4 dark:border-nord-1" data-astro-cid-v5yihett> <a href="/notes" class="btn-primary" data-astro-cid-v5yihett> <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" data-astro-cid-v5yihett> <path d="M15 19l-7-7 7-7" data-astro-cid-v5yihett></path> </svg>
Back to Notes
</a> </nav>  </main> <footer class="border-t border-nord-5 dark:border-nord-1 mt-12"> <div class="max-w-4xl mx-auto px-4 py-6 text-sm text-nord-3 dark:text-nord-4 text-center"> <p>&copy; 2026. All rights reserved.</p> </div> </footer> <script type="module" src="/_astro/Base.astro_astro_type_script_index_0_lang.WDMQca9J.js"></script> <script>
      (function() {
        const root = document.getElementById('series-dropdown-root');
        const trigger = document.getElementById('series-dropdown-trigger');
        const panel = document.getElementById('series-dropdown-panel');
        const listEl = document.getElementById('series-dropdown-list');
        if (!root || !trigger || !panel || !listEl) return;

        let seriesList = null;
        let hoverTimeout = null;

        function open() {
          panel.classList.remove('hidden');
          trigger.setAttribute('aria-expanded', 'true');
          if (seriesList === null) {
            fetch('/series-list.json')
              .then((r) => r.json())
              .then((list) => {
                seriesList = list;
                if (list.length === 0) {
                  listEl.innerHTML = '<span class="block px-3 py-2 text-xs text-nord-4 dark:text-nord-3">æš‚æ— ç³»åˆ—</span>';
                } else {
                  listEl.innerHTML = list.map(function(name) {
                     const slug = name.toLowerCase().replace(/\s+/g, '-');
                     const url = '/notes/series/' + slug;
                     return '<a href="' + url + '" class="block px-3 py-2 text-sm text-nord-9 dark:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-2 transition-colors" role="menuitem">' + escapeHtml(name) + '</a>';
                   }).join('');
                }
              })
              .catch(function() {
                listEl.innerHTML = '<span class="block px-3 py-2 text-xs text-nord-11">åŠ è½½å¤±è´¥</span>';
              });
          }
        }

        function close() {
          panel.classList.add('hidden');
          trigger.setAttribute('aria-expanded', 'false');
        }

        function escapeHtml(s) {
          const div = document.createElement('div');
          div.textContent = s;
          return div.innerHTML;
        }

        // On click: allow default navigation to /notes/series
        // On hover: show dropdown menu
        trigger.addEventListener('click', function(e) {
          e.stopPropagation();
          // Don't preventDefault - allow link to navigate
        });

        trigger.addEventListener('mouseenter', function() {
          if (hoverTimeout) clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(open, 200);
        });

        root.addEventListener('mouseleave', function() {
          if (hoverTimeout) { clearTimeout(hoverTimeout); hoverTimeout = null; }
          hoverTimeout = setTimeout(close, 150);
        });

        panel.addEventListener('mouseenter', function() {
          if (hoverTimeout) { clearTimeout(hoverTimeout); hoverTimeout = null; }
        });

        document.addEventListener('click', function(e) {
          if (!root.contains(e.target)) close();
        });
      })();
    </script> <script>
      (function() {
        const root = document.getElementById('tags-dropdown-root');
        const trigger = document.getElementById('tags-dropdown-trigger');
        const panel = document.getElementById('tags-dropdown-panel');
        const listEl = document.getElementById('tags-dropdown-list');
        if (!root || !trigger || !panel || !listEl) return;

        let tagList = null;
        let hoverTimeout = null;

        function open() {
          panel.classList.remove('hidden');
          trigger.setAttribute('aria-expanded', 'true');
          if (tagList === null) {
            fetch('/tag-list.json')
              .then((r) => r.json())
              .then((list) => {
                tagList = list;
                if (list.length === 0) {
                  listEl.innerHTML = '<span class="block px-3 py-2 text-xs text-nord-4 dark:text-nord-3">æš‚æ— æ ‡ç­¾</span>';
                } else {
                  listEl.innerHTML = list.map(function(tag) {
                     const url = '/notes/tag/' + encodeURIComponent(tag);
                     return '<a href="' + url + '" class="block px-3 py-2 text-sm text-nord-9 dark:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-2 transition-colors" role="menuitem">' + escapeHtml(tag) + '</a>';
                   }).join('');
                }
              })
              .catch(function() {
                listEl.innerHTML = '<span class="block px-3 py-2 text-xs text-nord-11">åŠ è½½å¤±è´¥</span>';
              });
          }
        }

        function close() {
          panel.classList.add('hidden');
          trigger.setAttribute('aria-expanded', 'false');
        }

        function escapeHtml(s) {
          const div = document.createElement('div');
          div.textContent = s;
          return div.innerHTML;
        }

        trigger.addEventListener('click', function(e) {
          e.stopPropagation();
        });

        trigger.addEventListener('mouseenter', function() {
          if (hoverTimeout) clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(open, 200);
        });

        root.addEventListener('mouseleave', function() {
          if (hoverTimeout) { clearTimeout(hoverTimeout); hoverTimeout = null; }
          hoverTimeout = setTimeout(close, 150);
        });

        panel.addEventListener('mouseenter', function() {
          if (hoverTimeout) { clearTimeout(hoverTimeout); hoverTimeout = null; }
        });

        document.addEventListener('click', function(e) {
          if (!root.contains(e.target)) close();
        });
      })();
    </script> </body> </html>  <script>
  // Language aliases (matches server-side)
  const langAliases = {
    js: 'javascript',
    ts: 'typescript',
    yml: 'yaml',
    yaml: 'yaml',
    sh: 'bash',
    shell: 'bash',
    sql: 'postgresql',
    java: 'openjdk',
  };

  // Add headers and copy buttons to code blocks
  function initCodeBlocks() {
    document.querySelectorAll('pre[data-language]').forEach((pre) => {
      // Skip if already processed
      if (pre.parentNode.classList.contains('code-block-wrapper')) return;
      
      const lang = pre.getAttribute('data-language') || 'code';
      
      // Create wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);
      
      // Create header
      const header = document.createElement('div');
      header.className = 'code-header';
      
      const langSpan = document.createElement('span');
      langSpan.className = 'code-header-lang';
      langSpan.title = lang;
      
      // Normalize lang for devicon
      const normalizedLang = lang.toLowerCase();
      const iconLang = langAliases[normalizedLang] || normalizedLang;
      
      // Display language with devicon (format: devicon-{name}-{version} colored)
      const iconEl = document.createElement('i');
      iconEl.className = `devicon-${iconLang}-plain colored`;
      iconEl.style.marginRight = '0.375rem';
      iconEl.style.fontSize = '0.75rem';
      langSpan.appendChild(iconEl);
      langSpan.appendChild(document.createTextNode(lang));
      
      const button = document.createElement('button');
      button.className = 'copy-code-btn';
      button.title = 'Copy to clipboard';
      button.innerHTML = '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      
      let isCopying = false;
      button.addEventListener('click', async () => {
        if (isCopying) return;
        isCopying = true;
        
        const code = pre.querySelector('code')?.textContent || '';
        try {
          await navigator.clipboard.writeText(code);
          const originalHtml = button.innerHTML;
          button.innerHTML = '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
          button.title = 'Copied!';
          setTimeout(() => {
            button.innerHTML = originalHtml;
            button.title = 'Copy to clipboard';
            isCopying = false;
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          isCopying = false;
        }
      });
      
      header.appendChild(langSpan);
      header.appendChild(button);
      wrapper.appendChild(header);
    });
  }

  // Run ASAP, then on DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCodeBlocks);
  } else {
    initCodeBlocks();
  }

  // Convert wikilinks to links on client side
  // Matches [[ref]] or [[ref|display text]]
  document.addEventListener('DOMContentLoaded', () => {
    const wikiRegex = /\[\[([a-zA-Z0-9][a-zA-Z0-9_-]*?)(?:\|([^\]]+))?\]\]/g;
    
    // Process all text nodes in prose content
    const walker = document.createTreeWalker(
      document.querySelector('.prose') || document.body,
      NodeFilter.SHOW_TEXT,
      null,
      false
    );
    
    const nodesToReplace = [];
    let node;
    
    while (node = walker.nextNode()) {
      if (node.nodeValue.includes('[[')) {
        nodesToReplace.push(node);
      }
    }
    
    nodesToReplace.forEach((textNode) => {
      const parent = textNode.parentNode;
      let lastIndex = 0;
      const matches = [...textNode.nodeValue.matchAll(wikiRegex)];
      
      if (matches.length === 0) return;
      
      const fragment = document.createDocumentFragment();
      
      matches.forEach((match) => {
        const [fullMatch, ref, displayText] = match;
        const startIndex = match.index;
        
        // Add text before match
        if (startIndex > lastIndex) {
          fragment.appendChild(
            document.createTextNode(textNode.nodeValue.slice(lastIndex, startIndex))
          );
        }
        
        // Create link
        const link = document.createElement('a');
        link.href = `/notes/${ref.toLowerCase()}`;
        link.textContent = (displayText || ref).trim();
        link.className = 'text-nord-9 dark:text-nord-8 hover:text-nord-10 dark:hover:text-nord-7 transition-colors';
        fragment.appendChild(link);
        
        lastIndex = startIndex + fullMatch.length;
      });
      
      // Add remaining text
      if (lastIndex < textNode.nodeValue.length) {
        fragment.appendChild(
          document.createTextNode(textNode.nodeValue.slice(lastIndex))
        );
      }
      
      parent.replaceChild(fragment, textNode);
    });
  });
</script> 