<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Blog"><title>memory</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.16.0/devicon.min.css"><script>
      // This script runs synchronously in the head to prevent FOUC (Flash of Unstyled Content)
      (function() {
        const THEME_KEY = 'nord-theme';
        const DARK = 'dark';
        
        function getStoredTheme() {
          try {
            return localStorage.getItem(THEME_KEY);
          } catch {
            return null;
          }
        }
        
        function getSystemTheme() {
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : 'light';
        }
        
        function getTheme() {
          return getStoredTheme() || getSystemTheme();
        }
        
        function applyTheme(theme) {
          const html = document.documentElement;
          if (theme === DARK) {
            html.classList.add('dark');
          } else {
            html.classList.remove('dark');
          }
        }
        
        // Apply theme immediately before page renders
        applyTheme(getTheme());
      })();
    </script><link rel="stylesheet" href="/_astro/_id_.6ed6JusR.css">
<style>.knowledge-graph-container[data-astro-cid-zjb43jqo]{border:1px solid var(--nord-4);border-radius:8px;background:var(--nord-6);position:relative;overflow:hidden}.knowledge-graph-container[data-astro-cid-zjb43jqo]:fullscreen,.knowledge-graph-container[data-astro-cid-zjb43jqo]::-webkit-full-screen{width:100vw;height:100vh;border-radius:0}.knowledge-graph-container[data-astro-cid-zjb43jqo]:fullscreen .knowledge-graph-wrapper[data-astro-cid-zjb43jqo],.knowledge-graph-container[data-astro-cid-zjb43jqo]::-webkit-full-screen .knowledge-graph-wrapper[data-astro-cid-zjb43jqo]{width:100%;height:100%}.knowledge-graph-toolbar{position:absolute;top:8px;right:8px;z-index:10;display:flex;gap:4px;align-items:center}.knowledge-graph-toolbar-btn{width:32px;height:32px;padding:0;border:1px solid var(--nord-4);border-radius:6px;background:var(--nord-6);color:var(--nord-2);font-size:16px;font-weight:600;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s,color .15s}.knowledge-graph-toolbar-btn:hover{background:var(--nord-5);color:var(--nord-10)}.knowledge-graph-toolbar-btn:active{background:var(--nord-4)}.knowledge-graph-wrapper[data-astro-cid-zjb43jqo]{width:100%;height:100%;display:flex;align-items:center;justify-content:center}.knowledge-graph-node{cursor:pointer;stroke:#5e81ac;stroke-width:2.5px;transition:all .2s ease}.knowledge-graph-node:hover{stroke-width:2.5px;filter:brightness(1.2)}.knowledge-graph-node.active{stroke:var(--nord-14);stroke-width:3px;filter:drop-shadow(0 0 8px rgba(191,97,106,.5))}.knowledge-graph-node--current{stroke:var(--nord-10);stroke-width:3px;filter:drop-shadow(0 0 6px rgba(94,129,172,.6))}.knowledge-graph-node--outlink{stroke:var(--nord-14);stroke-width:2.5px}.knowledge-graph-node--backlink{stroke:var(--nord-15);stroke-width:2.5px}.knowledge-graph-node--both{stroke:var(--nord-12);stroke-width:2.5px}.knowledge-graph-node--neighbor{stroke:var(--nord-4);stroke-width:2px;opacity:.9}.knowledge-graph-link{stroke:#4c566a;stroke-opacity:.85;stroke-width:2px}.knowledge-graph-link.active{stroke:var(--nord-11);stroke-opacity:.9;stroke-width:2px}.knowledge-graph-label{pointer-events:none;font-size:11px;text-anchor:middle;fill:var(--nord-1);font-weight:500;text-shadow:0 0 3px var(--nord-6)}.knowledge-graph-tooltip{position:absolute;padding:8px 12px;background:var(--nord-0);border:1px solid var(--nord-3);border-radius:4px;font-size:12px;color:var(--nord-6);pointer-events:none;z-index:1000;box-shadow:0 2px 8px #0000004d;white-space:nowrap}.knowledge-graph-tooltip-type{color:var(--nord-8);font-size:11px}.knowledge-graph-legend{position:absolute;bottom:8px;left:8px;z-index:10;display:flex;flex-wrap:wrap;gap:8px 12px;font-size:11px;color:var(--nord-2)}.kg-legend-item{display:inline-flex;align-items:center;gap:4px}.kg-legend--current{color:var(--nord-10)}.kg-legend--outlink{color:var(--nord-14)}.kg-legend--backlink{color:var(--nord-15)}.kg-legend--both{color:var(--nord-12)}.kg-legend--neighbor{color:var(--nord-4);opacity:.9}
html{scroll-behavior:smooth}article[data-astro-cid-v5yihett]{word-break:break-word}
</style></head> <body class="text-nord-3 dark:text-nord-5 transition-all bg-gradient-light"> <header class="border-b border-nord-5 dark:border-nord-1 bg-nord-6 dark:bg-nord-0"> <nav class="max-w-4xl mx-auto px-4 py-5 flex items-center justify-between gap-4"> <div class="flex items-center gap-2 min-w-0"> <a href="/" title="Liu" class="shrink-0 p-1.5 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-lg dark:hover:shadow-nord-8/20 active:scale-95"> <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"> <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg> </a> <h1 class="text-xl font-bold truncate"> <a href="/" class="text-nord-2 dark:text-nord-6 hover:text-nord-10 dark:hover:text-nord-8 transition-colors"> Liu </a> </h1> </div> <div class="flex items-center gap-2 shrink-0"> <a href="https://github.com/gh-liu" title="GitHub" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex active:scale-95"> <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-label="GitHub"> <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path> </svg> </a> <a href="https://x.com" title="X" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex active:scale-95"> <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-label="X"> <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24h-6.657l-5.207-6.807-5.975 6.807H2.306l7.644-8.74-8.179-10.76h6.467l4.713 6.231 5.429-6.231zM17.002 18.807h1.844L6.983 4.126H5.025l11.977 14.681z"></path> </svg> </a> <span class="w-px h-4 bg-nord-4 dark:bg-nord-2 shrink-0" aria-hidden="true"></span> <div class="relative series-dropdown" id="series-dropdown-root"> <a href="/notes/series" title="Series" aria-expanded="false" aria-haspopup="true" aria-controls="series-dropdown-panel" id="series-dropdown-trigger" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex active:scale-95"> <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M4 6h16M4 12h16M4 18h16"></path> </svg> </a> <div id="series-dropdown-panel" class="absolute right-0 top-full mt-1 py-2 min-w-[12rem] max-h-[70vh] overflow-y-auto rounded-lg border border-nord-4 dark:border-nord-2 bg-nord-6 dark:bg-nord-1 shadow-lg z-50 hidden" role="menu"> <div id="series-dropdown-list" class="py-1"> <span class="block px-3 py-2 text-xs text-nord-4 dark:text-nord-3">åŠ è½½ä¸­â€¦</span> </div> <div class="border-t border-nord-4 dark:border-nord-2 pt-1 mt-1"> <a href="/notes/series" class="block px-3 py-2 text-sm text-nord-9 dark:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-2 transition-colors">
æŸ¥çœ‹å…¨éƒ¨ç³»åˆ— â†’
</a> </div> </div> </div> <div class="relative tags-dropdown" id="tags-dropdown-root"> <a href="/notes/tags" title="Tags" aria-expanded="false" aria-haspopup="true" aria-controls="tags-dropdown-panel" id="tags-dropdown-trigger" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex active:scale-95"> <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M5 3h14v17L12 17l-7 3V3z"></path> </svg> </a> <div id="tags-dropdown-panel" class="absolute right-0 top-full mt-1 py-2 min-w-[12rem] max-h-[70vh] overflow-y-auto rounded-lg border border-nord-4 dark:border-nord-2 bg-nord-6 dark:bg-nord-1 shadow-lg z-50 hidden" role="menu"> <div id="tags-dropdown-list" class="py-1"> <span class="block px-3 py-2 text-xs text-nord-4 dark:text-nord-3">åŠ è½½ä¸­â€¦</span> </div> <div class="border-t border-nord-4 dark:border-nord-2 pt-1 mt-1"> <a href="/notes/tags" class="block px-3 py-2 text-sm text-nord-9 dark:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-2 transition-colors">
æŸ¥çœ‹å…¨éƒ¨æ ‡ç­¾ â†’
</a> </div> </div> </div> <div class="search-container" id="search-wrapper" data-astro-cid-t47yvtpn><button id="search-toggle" class="p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-2 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 transition-all duration-300 ease-out hover:scale-110 hover:shadow-md dark:hover:shadow-md dark:hover:shadow-nord-8/15 inline-flex" aria-label="Search notes" title="Search (âŒ˜K)" data-astro-cid-t47yvtpn><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" data-astro-cid-t47yvtpn><circle cx="11" cy="11" r="8" data-astro-cid-t47yvtpn></circle><path d="m21 21-4.35-4.35" data-astro-cid-t47yvtpn></path></svg></button><div id="search-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-start justify-center pt-20 backdrop-blur-sm" data-astro-cid-t47yvtpn><div class="bg-nord-6 dark:bg-nord-0 rounded-2xl shadow-2xl w-full max-w-2xl border border-nord-5 dark:border-nord-1 max-h-[70vh] flex flex-col overflow-hidden animate-fade-in" data-astro-cid-t47yvtpn><div class="p-4 border-b border-nord-5 dark:border-nord-1" data-astro-cid-t47yvtpn><input type="search" id="search-input" placeholder="Search notes... (use #tag for tag search)" class="w-full px-4 py-2 bg-nord-5 dark:bg-nord-1 text-nord-2 dark:text-nord-6 placeholder-nord-3 dark:placeholder-nord-4 rounded focus:outline-none focus:ring-2 focus:ring-nord-9 dark:focus:ring-nord-8" autocomplete="off" data-astro-cid-t47yvtpn></div><div id="search-results" class="flex-1 overflow-y-auto p-4" data-astro-cid-t47yvtpn><p class="text-nord-3 dark:text-nord-5 text-sm" data-astro-cid-t47yvtpn>Type to search...</p></div><div class="p-3 border-t border-nord-5 dark:border-nord-1 text-xs text-nord-3 dark:text-nord-4" data-astro-cid-t47yvtpn><p data-astro-cid-t47yvtpn>Press <kbd class="px-1 py-0.5 bg-nord-4 dark:bg-nord-2 rounded" data-astro-cid-t47yvtpn>Esc</kbd> to close | Use <kbd class="px-1 py-0.5 bg-nord-4 dark:bg-nord-2 rounded" data-astro-cid-t47yvtpn>#tag</kbd> to search by tag</p></div></div></div></div><script>(function(){const pagefindUrl = "/pagefind/pagefind.js";

  if (!globalThis.pagefindLoaded) {
    globalThis.pagefindLoaded = true;
    
    let pagefind;
    let searchInput;
    let searchModal;
    let searchResults;
    let isSearchOpen = false;

    async function initSearch() {
      if (typeof window === "undefined") return;

      try {
        pagefind = await import(pagefindUrl);
        await pagefind.init();
      } catch (error) {
        console.log("Search not available.", error);
        return;
      }

      searchInput = document.getElementById("search-input");
      searchModal = document.getElementById("search-modal");
      searchResults = document.getElementById("search-results");
      const toggleBtn = document.getElementById("search-toggle");

      if (!searchInput || !searchModal || !searchResults || !toggleBtn) return;

      toggleBtn.addEventListener("click", () => {
        openSearch();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeSearch();
        }
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          isSearchOpen ? closeSearch() : openSearch();
        }
      });

      searchModal.addEventListener("click", (e) => {
        if (e.target === searchModal) closeSearch();
      });

      searchInput.addEventListener("input", async (e) => {
        const query = e.target.value.trim();
        if (!query) {
          searchResults.innerHTML = '<p class="text-nord-3 dark:text-nord-5 text-sm">Type to search...</p>';
          return;
        }

        // Check if query starts with #tag
        const isTagSearch = query.startsWith('#');
        let results;
        
        if (isTagSearch) {
          // Tag search
          const tag = query.slice(1).toUpperCase();
          results = await pagefind.search(`tag:${tag}`);
        } else {
          // Regular text search
          results = await pagefind.search(query);
        }

        if (results.results.length === 0) {
          searchResults.innerHTML = '<p class="text-nord-3 dark:text-nord-5 text-sm">No results found.</p>';
          return;
        }

        let html = '<ul class="space-y-2">';
        for (const result of results.results) {
          const data = await result.data();
          // Extract title from h1 or use URL slug as fallback
          const title = data.meta?.title || data.title || (data.url.split('/').pop() || 'untitled').replace(/-/g, ' ');
          html += `<li><a href="${data.url}" class="block p-3 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-2 text-nord-9 dark:text-nord-8 hover:text-nord-10 dark:hover:text-nord-7 transition-all hover:shadow-md duration-200 border border-transparent hover:border-nord-9 dark:hover:border-nord-8"><div class="font-medium">${title}</div><div class="text-xs text-nord-3 dark:text-nord-5 mt-1 line-clamp-2">${data.excerpt || ""}</div></a></li>`;
        }
        searchResults.innerHTML = html + "</ul>";
      });
    }

    function openSearch() {
      isSearchOpen = true;
      searchModal.classList.remove("hidden");
      searchInput.focus();
      document.body.style.overflow = "hidden";
    }

    function closeSearch() {
      isSearchOpen = false;
      searchModal.classList.add("hidden");
      searchInput.value = "";
      searchResults.innerHTML = '<p class="text-nord-3 dark:text-nord-5 text-sm">Type to search...</p>';
      document.body.style.overflow = "";
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initSearch);
    } else {
      initSearch();
    }
  }
})();</script> <button id="theme-toggle" aria-label="Toggle theme" title="Toggle theme" class="group relative p-2 rounded-lg hover:bg-nord-5 dark:hover:bg-nord-1 text-nord-3 dark:text-nord-4 transition-all duration-200 ease-out hover:scale-110 inline-flex"> <span class="inline-block transition-transform duration-200 ease-out group-hover:rotate-12"> <svg id="sun-icon" class="w-4 h-4 text-nord-13 hidden dark:block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line> </svg> <svg id="moon-icon" class="w-4 h-4 text-nord-9 block dark:hidden" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path> </svg> </span> </button> <script>
  const THEME_KEY = 'nord-theme';
  const DARK = 'dark';
  
  function getStoredTheme() {
    return localStorage.getItem(THEME_KEY);
  }
  
  function getSystemTheme() {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : 'light';
  }
  
  function getTheme() {
    return getStoredTheme() || getSystemTheme();
  }
  
  function applyTheme(theme) {
    const html = document.documentElement;
    if (theme === DARK) {
      html.classList.add('dark');
    } else {
      html.classList.remove('dark');
    }
  }
  
  function toggleTheme() {
    const currentTheme = getTheme();
    const newTheme = currentTheme === DARK ? 'light' : DARK;
    localStorage.setItem(THEME_KEY, newTheme);
    applyTheme(newTheme);
  }
  
  const themeToggle = document.getElementById('theme-toggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', toggleTheme);
  }
</script> </div> </nav> </header> <main class="max-w-4xl mx-auto px-4 py-12" data-pagefind-body> <aside id="toc-sidebar" class="fixed left-0 top-0 h-screen w-56 bg-nord-6 dark:bg-nord-0 border-r border-nord-5 dark:border-nord-1 overflow-y-auto overflow-x-hidden pt-4 pb-4 transition-transform duration-300 -translate-x-full z-50" data-astro-cid-vrmg3htk> <nav class="px-4 space-y-1" data-astro-cid-vrmg3htk> <!-- Close button --> <button id="toc-close" class="flex justify-end w-full mb-4 p-2 text-nord-2 dark:text-nord-6 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors" aria-label="Close navigation" data-astro-cid-vrmg3htk> <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" data-astro-cid-vrmg3htk> <path d="M18 6L6 18M6 6l12 12" data-astro-cid-vrmg3htk></path> </svg> </button> <h3 class="text-xs font-bold text-nord-2 dark:text-nord-6 uppercase tracking-widest px-2 py-3 border-b border-nord-5 dark:border-nord-1" data-astro-cid-vrmg3htk>
On this page
</h3> <ul class="space-y-0.5 text-sm mt-4" data-astro-cid-vrmg3htk> <li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#001--alloc" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 0.0.1 Â· Alloc </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#002--gc" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 0.0.2 Â· GC </a> </li><li class="toc-item pl-0" data-astro-cid-vrmg3htk> <a href="#01--garbage-collection" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="2" data-astro-cid-vrmg3htk> 0.1 Â· Garbage collection </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#011--gc-phases" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 0.1.1 Â· GC Phases </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#012--stw" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 0.1.2 Â· STW </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#013--tri-color-mark--sweep" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 0.1.3 Â· Tri-color mark &amp;&amp; sweep </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#014--gc-writer-barrier" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 0.1.4 Â· GC writer barrier </a> </li><li class="toc-item pl-4" data-astro-cid-vrmg3htk> <a href="#015--gc-pacing-algorithm" class="block py-1.5 px-2 text-nord-3 dark:text-nord-5 hover:text-nord-9 dark:hover:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-1 rounded transition-colors truncate" data-depth="3" data-astro-cid-vrmg3htk> 0.1.5 Â· Gc pacing algorithm </a> </li> </ul> </nav> </aside> <!-- Toggle button - fixed at left edge --> <button id="toc-toggle" class="fixed left-0 top-4 p-3 rounded-r-lg bg-nord-9 dark:bg-nord-8 text-nord-6 dark:text-nord-0 hover:bg-nord-10 dark:hover:bg-nord-7 hover:text-nord-6 dark:hover:text-nord-0 transition-colors shadow-lg z-40" aria-label="Toggle sidebar" title="Toggle sidebar (â† â†’)" data-astro-cid-vrmg3htk> <svg id="toggle-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" data-astro-cid-vrmg3htk> <path d="M4 6h16M4 12h16M4 18h16" data-astro-cid-vrmg3htk></path> </svg> </button> <script>
  const TOC_KEY = 'toc-open';
  const sidebar = document.getElementById('toc-sidebar');
  const toggle = document.getElementById('toc-toggle');
  const closeBtn = document.getElementById('toc-close');

  function getSidebarState() {
    return localStorage.getItem(TOC_KEY) !== 'false';
  }

  function setSidebarState(open) {
    localStorage.setItem(TOC_KEY, open ? 'true' : 'false');
  }

  function updateSidebar() {
    const isOpen = getSidebarState();
    if (sidebar) {
      if (isOpen) {
        sidebar.classList.remove('-translate-x-full');
      } else {
        sidebar.classList.add('-translate-x-full');
      }
    }
  }

  function toggleSidebar() {
    const isOpen = getSidebarState();
    setSidebarState(!isOpen);
    updateSidebar();
  }

  // Initialize
  updateSidebar();

  // Event listeners
  if (toggle) {
    toggle.addEventListener('click', toggleSidebar);
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', toggleSidebar);
  }

  // Keyboard shortcut: left/right arrow to toggle
  document.addEventListener('keydown', (e) => {
    if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && e.ctrlKey) {
      e.preventDefault();
      toggleSidebar();
    }
  });

  // Highlight current section on scroll
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          document.querySelectorAll('.toc-item a').forEach((link) => {
            link.classList.remove('text-nord-9', 'dark:text-nord-8', 'font-semibold', 'bg-nord-5', 'dark:bg-nord-1');
            link.classList.add('text-nord-3', 'dark:text-nord-4');
          });
          const activeLink = document.querySelector(
            `.toc-item a[href="#${entry.target.id}"]`
          );
          if (activeLink) {
            activeLink.classList.remove('text-nord-3', 'dark:text-nord-4');
            activeLink.classList.add('text-nord-9', 'dark:text-nord-8', 'font-semibold', 'bg-nord-5', 'dark:bg-nord-1');
          }
        }
      });
    },
    { rootMargin: '-50% 0px -50% 0px' }
  );

  document.querySelectorAll('h2, h3').forEach((heading) => {
    if (heading.id) {
      observer.observe(heading);
    }
  });

  // Close sidebar on link click
  document.querySelectorAll('.toc-item a').forEach((link) => {
    link.addEventListener('click', () => {
      setSidebarState(false);
      updateSidebar();
    });
  });
</script>  <article class="prose prose-nord dark:prose-nord max-w-none
      prose-headings:font-serif
      prose-code:before:content-none prose-code:after:content-none" data-astro-cid-v5yihett> <header class="mb-8" data-astro-cid-v5yihett> <h1 class="mb-3" data-pagefind-meta="title" data-astro-cid-v5yihett>memory</h1> <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-4" data-astro-cid-v5yihett> <div class="text-sm text-nord-3 dark:text-nord-5" data-astro-cid-v5yihett> <div> <div class="flex flex-wrap gap-2 mb-2"> <span class="inline-flex items-center gap-1 px-2.5 py-1 text-xs bg-nord-7 dark:bg-nord-7 text-nord-0 dark:text-nord-0 rounded font-medium"> <span>ğŸ“…</span> <span>2026-02-05</span> </span> <span class="inline-flex items-center gap-1 px-2.5 py-1 text-xs bg-nord-8 dark:bg-nord-8 text-nord-0 dark:text-nord-0 rounded font-medium"> <span>âœï¸</span> <span>2026-02-05</span> </span>  <div class="flex flex-wrap gap-2"> <a href="/notes/tag/CS" class="inline-flex items-center gap-1 px-2.5 sm:px-3 py-1.5 sm:py-1 text-xs sm:text-xs font-semibold rounded bg-nord-6 dark:bg-nord-2/60 shadow-sm dark:shadow-md transition-all duration-200 ease-out hover:shadow-md dark:hover:shadow-lg hover:translate-y-[-1px] tag-text-blue-light dark:tag-text-blue-dark !no-underline hover:!no-underline" title="Tag: CS"> <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M5 3h14v17L12 17l-7 3V3z"></path> </svg> <span>CS</span>  </a><a href="/notes/tag/GO" class="inline-flex items-center gap-1 px-2.5 sm:px-3 py-1.5 sm:py-1 text-xs sm:text-xs font-semibold rounded bg-nord-6 dark:bg-nord-2/60 shadow-sm dark:shadow-md transition-all duration-200 ease-out hover:shadow-md dark:hover:shadow-lg hover:translate-y-[-1px] tag-text-blue-light dark:tag-text-blue-dark !no-underline hover:!no-underline" title="Tag: GO"> <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M5 3h14v17L12 17l-7 3V3z"></path> </svg> <span>GO</span>  </a> </div> </div> </div> </div> <div class="text-sm" data-astro-cid-v5yihett> <div> <div class="flex items-center gap-4"> <!-- Back to notes link - removed, now in footer --> <!-- Show only links and backlinks stats --> <!-- Outlinks -->  <!-- Backlinks -->  <!-- No links message --> <span class="text-nord-3 dark:text-nord-4 italic">No related notes</span> </div> <!-- Modals --> <div id="outlinks-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"> <div class="bg-nord-6 dark:bg-nord-0 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-nord-5 dark:border-nord-1"> <!-- Header --> <div class="sticky top-0 bg-nord-6 dark:bg-nord-0 border-b border-nord-5 dark:border-nord-1 px-6 py-4 flex items-center justify-between"> <h2 class="text-lg font-semibold text-nord-2 dark:text-nord-6"> Outlinks <span class="text-sm font-normal text-nord-3 dark:text-nord-5 ml-2">
(0)
</span> </h2> <button class="close-modal p-1 text-nord-3 dark:text-nord-4 hover:bg-nord-5 dark:hover:bg-nord-1 hover:text-nord-2 dark:hover:text-nord-5 rounded transition-colors" aria-label="Close modal"> <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M18 6L6 18M6 6l12 12"></path> </svg> </button> </div> <!-- Content --> <div class="p-6"> <p class="text-nord-3 dark:text-nord-5 text-center py-8">
No outlinks found
</p> </div> </div> </div> <script>(function(){const modalId = "outlinks-modal";
const type = "outlinks";

  const modal = document.getElementById(modalId);
  const closeButtons = modal ? modal.querySelectorAll('.close-modal') : [];

  // Create camelCase function name: "backlinks" -> "openBacklinksModal"
  const functionName = `open${type.charAt(0).toUpperCase() + type.slice(1)}Modal`;

  // Open modal
  window[functionName] = function() {
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  };

  // Close modal
  function closeModal() {
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  // Close button listeners
  closeButtons.forEach((btn) => {
    btn.addEventListener('click', closeModal);
  });

  // Close on background click
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });
  }

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeModal();
    }
  });
})();</script> <div id="backlinks-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"> <div class="bg-nord-6 dark:bg-nord-0 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-nord-5 dark:border-nord-1"> <!-- Header --> <div class="sticky top-0 bg-nord-6 dark:bg-nord-0 border-b border-nord-5 dark:border-nord-1 px-6 py-4 flex items-center justify-between"> <h2 class="text-lg font-semibold text-nord-2 dark:text-nord-6"> Backlinks <span class="text-sm font-normal text-nord-3 dark:text-nord-5 ml-2">
(0)
</span> </h2> <button class="close-modal p-1 text-nord-3 dark:text-nord-4 hover:bg-nord-5 dark:hover:bg-nord-1 hover:text-nord-2 dark:hover:text-nord-5 rounded transition-colors" aria-label="Close modal"> <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"> <path d="M18 6L6 18M6 6l12 12"></path> </svg> </button> </div> <!-- Content --> <div class="p-6"> <p class="text-nord-3 dark:text-nord-5 text-center py-8">
No backlinks found
</p> </div> </div> </div> <script>(function(){const modalId = "backlinks-modal";
const type = "backlinks";

  const modal = document.getElementById(modalId);
  const closeButtons = modal ? modal.querySelectorAll('.close-modal') : [];

  // Create camelCase function name: "backlinks" -> "openBacklinksModal"
  const functionName = `open${type.charAt(0).toUpperCase() + type.slice(1)}Modal`;

  // Open modal
  window[functionName] = function() {
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  };

  // Close modal
  function closeModal() {
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  // Close button listeners
  closeButtons.forEach((btn) => {
    btn.addEventListener('click', closeModal);
  });

  // Close on background click
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });
  }

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeModal();
    }
  });
})();</script> <script>
  // Outlinks button - calls window.openOutlinksModal()
  document.querySelectorAll('.open-outlinks-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      if (window.openOutlinksModal) {
        window.openOutlinksModal();
      }
    });
  });

  // Backlinks button - calls window.openBacklinksModal()
  document.querySelectorAll('.open-backlinks-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      if (window.openBacklinksModal) {
        window.openBacklinksModal();
      }
    });
  });
</script> </div> </div> </div> </header>    <p><a href="https://povilasv.me/go-memory-management/">https://povilasv.me/go-memory-management/</a>
<a href="https://povilasv.me/go-memory-management-part-2/">https://povilasv.me/go-memory-management-part-2/</a>
<a href="https://povilasv.me/go-memory-management-part-3/">https://povilasv.me/go-memory-management-part-3/</a></p>
<p>runtime/mem.go
å››ç§çŠ¶æ€ï¼š</p>
<ol>
<li>None - é»˜è®¤çš„ç³»ç»Ÿå†…å­˜çš„çŠ¶æ€</li>
<li>Reserved - å½’è¿è¡Œæ—¶æ‰€æœ‰ï¼Œä½†æ˜¯è®¿é—®ä¼šæŠ¥é”™</li>
<li>Prepared - ï¼Ÿ</li>
<li>Ready - å¯å®‰å…¨è®¿é—®</li>
</ol>
<h3 id="001--alloc">0.0.1 Â· Alloc</h3>
<p><a href="https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/">https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/</a>
<a href="http://t.zoukankan.com/zpcoding-p-13259943.html">http://t.zoukankan.com/zpcoding-p-13259943.html</a></p>
<ol>
<li>ç±»ä¼¼TCMalloc</li>
<li>å°åˆ†é…ï¼ˆ32KBä»¥å†…ï¼‰ï¼Œä¼šå››èˆäº”å…¥åˆ°å¯¹åº”çš„å¤šç§ä¸åŒå¤§å°çš„å†…å­˜å—ï¼ˆ1B~32KBï¼‰ä¹‹ä¸€ï¼Œå†…å­˜é¡µé¢ä¼šåˆ†å‰²æˆå¯¹åº”æŸç§å¤§å°çš„å¯¹è±¡ï¼Œä½¿ç”¨bitmapç®¡ç†ï¼›</li>
<li>åˆ†é…å™¨çš„æ•°æ®ç»“æ„æœ‰: fixalloc, mheap(åˆ†é…å †ï¼Œç®¡ç†é¡µï¼ˆ8KBï¼‰), mspan(ä¸€è¿ä¸²ä½¿ç”¨ä¸­çš„é¡µ), mcentral(æŒ‡å®šå¤§å°çš„mspan), mcache(æ¯ä¸ªpä¸­çš„å¯ç”¨çš„mspan), mstatsï¼ˆåˆ†é…ç»Ÿè®¡ï¼‰</li>
</ol>
<p>åˆ†é…å°å¯¹è±¡:</p>
<ol>
<li>å››èˆäº”å…¥æˆä¸€ä¸ªç­‰çº§å¤§å°çš„å†…å­˜ï¼Œå»Pä¸­çš„mcacheä¸­æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„mspanï¼Œåœ¨mspançš„ä½å›¾ä¸­æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„æ§½ï¼Œåˆ†é…å…¶ï¼Œæ­¤æ“ä½œä¸ç”¨é”ï¼›</li>
<li>mspanæ²¡æœ‰å¯ç”¨çš„æ§½ï¼Œä»mcentralä¸­è·å–ä¸€ä¸ªæ–°çš„mspanï¼Œéœ€è¦é”ï¼›</li>
<li>mcentralæ˜¯ç©ºçš„ï¼Œåˆ™ä»mheapä¸­è·å–ä¸€è¿ä¸²çš„é¡µ</li>
<li>å¦‚æœmheapæ˜¯ç©ºçš„æˆ–è€…æ²¡æœ‰è¶³å¤Ÿå¤§å°çš„é¡µï¼Œä»æ“ä½œç³»ç»Ÿè·å–é¡µï¼ˆè‡³å°‘1MBï¼‰ï¼Œéœ€è¦è°ƒç”¨ç³»ç»Ÿè°ƒç”¨</li>
</ol>
<p>æ¸…é™¤mspanï¼Œé‡Šæ”¾å¯¹è±¡ï¼š</p>
<ol>
<li>å› ä¸ºåˆ†é…è€Œæ¸…é™¤çš„mspan, ä¸ºäº†æ»¡è¶³åˆ†é…è€Œè¿”å›ç»™mcache</li>
<li>å¦è€…ï¼Œå¦‚æœmspanä¾æ—§æœ‰åˆ†é…çš„å¯¹è±¡åœ¨ï¼Œåˆ™æ”¾åœ¨mcentralä¸­å¯¹åº”çš„mspanå¤§å°åˆ—è¡¨ä¸­</li>
<li>å¦è€…ï¼Œmspanä¸­çš„å¯¹è±¡è¢«é‡Šæ”¾ï¼Œmspanè¢«è¿”å›ç»™mheap</li>
</ol>
<p>åˆ†é…/é‡Šæ”¾å¤§å¯¹è±¡é¿å¼€mcacheå’Œmcentralï¼Œç›´æ¥ä¸mheapäº¤äº’</p>
<p>mspan.needzero? é›¶å€¼?</p>
<p>è™šæ‹Ÿå†…å­˜å¸ƒå±€ï¼š
heapç”±ä¸€ç³»åˆ—çš„arenasç»„æˆï¼Œåœ¨64ä½ä¸Šä¸º64MBï¼Œåœ¨32ä½ä¸Šä¸º4MB;
æ¯ä¸€ä¸ªarenaså…³è¿ä¸€ä¸ªheapArenaå¯¹è±¡ï¼Œå…¶å­˜å‚¨äº†arenaçš„å…ƒæ•°æ®: heapä½å›¾å¯¹åº”arenaä¸­çš„æ‰€æœ‰wordï¼Œspanå›¾å¯¹åº”arenaä¸­çš„æ‰€æœ‰é¡µï¼ŒheapAreaä¸åœ¨å †ä¸Šåˆ†é…ï¼›
ç”±äºarenasæ˜¯å¯¹å…¶çš„ï¼Œå› æ­¤å¯ä»¥æŠŠå†…å­˜ç©ºé—´çœ‹æˆä¸€è¿ä¸²çš„arenasï¼Œmheap._areansæ˜ å°„ç€ä¸€ç³»åˆ—çš„heapArenaå¯¹è±¡ï¼›è¿™ä¸ªæ˜ å°„ç”±äºŒç»´æ•°ç»„ç»„æˆï¼ŒL1å’Œè®¸å¤šL2ï¼Œè®¸å¤šæœºå™¨ä¸Šå¯èƒ½åªæœ‰å•ä¸ªL2æ˜ å°„ï¼›</p>
<p>mksizeclasses.go
ç”Ÿæˆå°åˆ†é…å¤§å°çš„ç­‰çº§ï¼Œæ¯ä¸ªçº§åˆ«ä¹‹é—´å·®12.5%ï¼Œ</p>
<p>ä»¥32KBä¸ºç•Œé™ï¼Œåˆ†ä¸ºå¤§å°å¯¹è±¡ï¼›
tiny ï¼šsize &#x3C; 16 bytes &#x26;&#x26; has no pointer(noscan)
small ï¼šhas pointer(scan) || (size >= 16 bytes &#x26;&#x26; size &#x3C;= 32 KB)
large ï¼šsize > 32 KB
å…¶ä¸­å°å¯¹è±¡å¦‚æœæ— æŒ‡é’ˆä¸”å°äº16Bï¼Œè§†ä½œå¾®å¯¹è±¡ï¼›
å¾®å¯¹è±¡ï¼šå°†å‡ ä¸ªå¾®å°å¯¹è±¡åˆ†é…è¯·æ±‚æ•´åˆåˆ°ä¸€ä¸ªå†…å­˜å—å†…ï¼›
å°å¯¹è±¡ï¼šæ ¹æ®å¤§å°ï¼Œæ‰¾åˆ°å¯¹åº”çš„sizeclassï¼Œå†è·å–åˆ°sizeï¼Œå†è·å–åˆ°spançš„classï¼Œå†ä»mcacheä¸­æ‹¿å‡ºä¸€ä¸ªspan
å¤§å¯¹è±¡ï¼šç›´æ¥ä»mheapåˆ†é…span</p>
<p>ä½¿ç”¨spanæœºåˆ¶æ¥å‡å°‘ç¢ç‰‡,æ¯ä¸ªspanè‡³å°‘ä¸ºä¸€ä¸ªé¡µ,ä¸€å…±æœ‰70ä¸ªsizeèŒƒå›´, 8byte-32KB, æ¯ä¸ªsizeæœ‰ä¸¤ç§ç±»å‹(scanå’Œnoscan, è¡¨ç¤ºåˆ†é…çš„å¯¹è±¡æ˜¯å¦ä¼šåŒ…å«æŒ‡é’ˆ)
å¤šå±‚æ¬¡Cacheæ¥å‡å°‘åˆ†é…çš„å†²çª: per-Pæ— é”çš„mcache, å…¨å±€67<em>2ä¸ªå¯¹åº”ä¸åŒsizeçš„spançš„åå¤‡mcentral, å…¨å±€1ä¸ªçš„mheap.
mheapä¸­ä»¥treapçš„ç»“æ„ç»´æŠ¤ç©ºé—²è¿ç»­page. å½’è¿˜å†…å­˜åˆ°mheapæ—¶, è¿ç»­åœ°å€ä¼šè¿›è¡Œåˆå¹¶. (1.11ä¹‹å‰é‡‡ç”¨ç±»ä¼¼ä¼™ä¼´ç³»ç»Ÿç»´æŠ¤&#x3C;1MBçš„è¿ç»­page, treapç»´æŠ¤>1MBçš„è¿ç»­page)
goä»£ç åˆ†é…å†…å­˜ä¼˜å…ˆä»å½“å‰pçš„mcacheå¯¹åº”sizeçš„spanä¸­è·å–; æœ‰çš„è¯, å†ä»å¯¹åº”sizeçš„mcentralä¸­è·å–ä¸€ä¸ªspan; è¿˜æ²¡æœ‰çš„è¯, ä»mheapä¸­sweepä¸€ä¸ªspan; sweepä¸å‡ºæ¥, åˆ™ä»mheapä¸­ç©ºé—²å—æ‰¾åˆ°å¯¹åº”spanå¤§å°çš„å†…å­˜. mheapä¸­å¦‚æœè¿˜æ²¡æœ‰, åˆ™ä»ç³»ç»Ÿç”³è¯·å†…å­˜. ä»æ— é”åˆ°å…¨å±€1/(67</em>2)ç²’åº¦çš„é”, å†åˆ°å…¨å±€é”, å†åˆ°ç³»ç»Ÿè°ƒç”¨.
stackåˆ†é…ä¹Ÿæ˜¯å¤šå±‚æ¬¡å’Œå¤šclassçš„.å‡å°‘åˆ†é…çš„é”äº‰æŠ¢, å‡å°‘æ ˆæµªè´¹.
å¯¹è±¡ç”±GCè¿›è¡Œé‡Šæ”¾. sysmonä¼šå®šæ—¶æŠŠmheapç©ºä½™çš„å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿ</p>
<h3 id="002--gc">0.0.2 Â· GC</h3>
<p><a href="https://making.pusher.com/golangs-real-time-gc-in-theory-and-practice/">https://making.pusher.com/golangs-real-time-gc-in-theory-and-practice/</a></p>
<p><a href="https://studygolang.com/articles/23364">https://studygolang.com/articles/23364</a></p>
<p><a href="https://juejin.cn/post/6844903940186701831">https://juejin.cn/post/6844903940186701831</a></p>
<p><a href="https://mp.weixin.qq.com/s/AaHk-yg8D4atbO-zVAvhKQ?forceh5=1">https://mp.weixin.qq.com/s/AaHk-yg8D4atbO-zVAvhKQ?forceh5=1</a></p>
<p><a href="https://memorymanagement.org/">https://memorymanagement.org/</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/402759799">https://zhuanlan.zhihu.com/p/402759799</a></p>
<p><a href="https://gchandbook.org/">https://gchandbook.org/</a></p>
<p><a href="https://docs.google.com/document/d/1gCsFxXamW8RRvOe5hECz98Ftk-tcRRJcDFANj2VwCB0/edit">https://docs.google.com/document/d/1gCsFxXamW8RRvOe5hECz98Ftk-tcRRJcDFANj2VwCB0/edit</a></p>
<p><a href="https://docs.google.com/document/d/1wmjrocXIWTr1JxU-3EQBI6BK6KgtiFArkG47XK73xIQ/edit#">https://docs.google.com/document/d/1wmjrocXIWTr1JxU-3EQBI6BK6KgtiFArkG47XK73xIQ/edit#</a>
<a href="https://github.com/golang/proposal/blob/master/design/14951-soft-heap-limit.md">https://github.com/golang/proposal/blob/master/design/14951-soft-heap-limit.md</a></p>
<p>åœ¨ GC çš„è¿‡ç¨‹ä¸­åŒæ—¶è¿è¡Œçš„ g ç§°ä¸ºmutatorï¼Œmutator assistæœºåˆ¶å°±æ˜¯ g è¾…åŠ© GC åšä¸€éƒ¨åˆ†å·¥ä½œçš„æœºåˆ¶ã€‚
è¾…åŠ© GC åšçš„å·¥ä½œæœ‰ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯æ ‡è®°ï¼ˆMarkï¼‰ï¼Œå¦ä¸€ç§æ˜¯æ¸…é™¤ï¼ˆSweepï¼‰ã€‚</p>
<p>ä½¿ç”¨å†™å±éšœçš„å¹¶å‘æ ‡è®°ä¸æ¸…é™¤ï¼›
éåˆ†ä»£ã€éå‹ç¼©ï¼›</p>
<p>åˆ†é…å†…å­˜æ˜¯é€šè¿‡æ¯ä¸ªpä¸­å¤§å°éš”ç¦»å¼€çš„åˆ†é…åŒºåŸŸå®Œæˆçš„ï¼Œåœ¨æ¶ˆé™¤å¸¸è§æƒ…å†µä¸‹çš„é”çš„åŒæ—¶ï¼Œæœ€å°åŒ–å†…å­˜ç¢ç‰‡ã€‚</p>
<ol>
<li>GC æ‰§è¡Œæ¸…é™¤ç»ˆæ­¢
a. STWï¼Œæ‰€æœ‰påˆ°GCå®‰å…¨ç‚¹
b. æ¸…é™¤ä»»ä½•æœªæ¸…é™¤è¿‡çš„spansï¼Œåªæœ‰åœ¨é¢„æœŸæ—¶é—´ä¹‹å‰ï¼Œå¼ºåˆ¶æ‰§è¡Œæ­¤æ¬¡GCæ—¶ï¼Œæ‰ä¼šæœ‰æœªæ¸…é™¤çš„span</li>
<li>GC æ‰§è¡Œæ ‡è®°é˜¶æ®µ
a. å‡†å¤‡æ ‡è®°é˜¶æ®µï¼Œå°†gcphaseè®¾ç½®ä¸º_GCmarkï¼ˆä»_GCoffå¼€å§‹ï¼‰ï¼Œå¯ç”¨å†™å±éšœï¼Œå¯ç”¨ mutator assistï¼Œå¹¶å¯¹æ ¹æ ‡è®°ä½œä¸šè¿›è¡Œæ’é˜Ÿã€‚åœ¨æ‰€æœ‰Péƒ½å¯ç”¨å†™å±éšœä¹‹å‰ï¼Œä¸ä¼šæ‰«æä»»ä½•å¯¹è±¡ï¼Œæ‰«ææ˜¯é€šè¿‡STWå®Œæˆçš„ï¼Ÿï¼Ÿ
b. Start the worldï¼Œä»ç°åœ¨å¼€å§‹ï¼ŒGC å·¥ä½œç”±è°ƒåº¦å™¨å¯åŠ¨çš„æ ‡è®°workerå’Œä½œä¸ºallocationçš„ä¸€éƒ¨åˆ†æ‰§è¡Œçš„assistsæ¥å®Œæˆï¼›å†™å±éšœç€è‰²è¢«è¦†å†™çš„æŒ‡é’ˆå’Œä»»ä½•æ–°æŒ‡é’ˆå€¼ï¼›æ–°åˆ†é…çš„å¯¹è±¡ç«‹å³è¢«æ ‡è®°ä¸ºé»‘è‰²
c. GC æ‰§è¡Œæ ¹æ ‡è®°ä½œä¸šã€‚åŒ…æ‹¬ï¼šæ‰«ææ‰€æœ‰æ ˆï¼Œç€è‰²æ‰€æœ‰å…¨å±€å˜é‡ï¼Œä»¥åŠç€è‰²å †å¤–è¿è¡Œæ—¶æ•°æ®ç»“æ„ä¸­çš„ä»»ä½•å †æŒ‡é’ˆï¼›æ‰«ææ ˆä¼šåœæ­¢goroutineï¼Œå¯¹goroutineæ ˆä¸­æ‰¾åˆ°çš„ä»»ä½•æŒ‡é’ˆè¿›è¡Œç€è‰²ï¼Œç„¶åæ¢å¤goroutine
d. GC è€—å°½ç°è‰²å¯¹è±¡çš„å·¥ä½œé˜Ÿåˆ—ï¼Œå°†æ¯ä¸ªç°è‰²å¯¹è±¡æ‰«æä¸ºé»‘è‰²ï¼Œå¹¶å¯¹åœ¨è¯¥å¯¹è±¡ä¸­æ‰¾åˆ°çš„æ‰€æœ‰æŒ‡é’ˆè¿›è¡Œç€è‰²ï¼ˆåè¿‡æ¥å¯èƒ½ä¼šå°†è¿™äº›æŒ‡é’ˆæ·»åŠ åˆ°ç°è‰²å·¥ä½œé˜Ÿåˆ—ä¸­ï¼‰
e. ç”±äº GC å·¥ä½œåˆ†æ•£åœ¨æœ¬åœ°ç¼“å­˜ä¸­ï¼Œå› æ­¤ GC ä½¿ç”¨åˆ†å¸ƒå¼ç»ˆæ­¢ç®—æ³•æ¥æ£€æµ‹ä½•æ—¶ä¸å†æœ‰æ ¹æ ‡è®°ä½œä¸šæˆ–ç°è‰²å¯¹è±¡ï¼ˆå‚è§gcMarkDoneå‡½æ•°ï¼‰ã€‚æ­¤æ—¶ï¼ŒGC çŠ¶æ€è½¬æ¢åˆ°æ ‡è®°ç»ˆæ­¢ï¼ˆgcMarkTerminationï¼‰</li>
<li>GC æ‰§è¡Œæ ‡è®°ç»ˆæ­¢
a. STW
b. å°†gcphaseè®¾ç½®ä¸º_GCmarkterminationï¼Œå¹¶ç¦ç”¨ workers å’Œ assistsã€‚
c. è¿›è¡Œå†…åŠ¡æ•´ç†ï¼Œå¦‚flushing mcaches</li>
<li>GC æ‰§è¡Œæ¸…é™¤é˜¶æ®µ
a. å‡†å¤‡æ¸…é™¤é˜¶æ®µï¼Œå°†gcphaseè®¾ç½®ä¸º_GCoffï¼Œè®¾ç½®æ¸…é™¤çŠ¶æ€å¹¶ç¦ç”¨å†™å±éšœ
b. Start the worldï¼Œä»ç°åœ¨å¼€å§‹ï¼Œæ–°åˆ†é…çš„å¯¹è±¡æ˜¯ç™½è‰²çš„ï¼Œå¦‚æœ‰å¿…è¦ï¼Œåœ¨ä½¿ç”¨spanså‰åˆ†é…æ¸…é™¤spans
c. GC åœ¨åå°è¿›è¡Œå¹¶å‘æ¸…é™¤å¹¶å“åº”å†…å­˜åˆ†é…</li>
<li>å½“å……è¶³çš„å†…å­˜åˆ†é…å‘ç”Ÿæ—¶ï¼Œé‡å¤ä¸Šé¢ä»¥ 1 å¼€å§‹çš„æ­¥éª¤ï¼Œå‚è§å…³äº GC rate çš„è®¨è®ºã€‚</li>
</ol>
<p>å¹¶å‘æ¸…é™¤ï¼š
åœ¨åå°goroutineä¸­ï¼Œå †è¢«æƒ°æ€§ï¼ˆå½“ goroutine éœ€è¦å¦ä¸€ä¸ªspanæ—¶ï¼‰ä¸”å¹¶å‘åœ°é€ä¸ªspanæ‰«æï¼ˆè¿™æœ‰åŠ©äºä¸æ˜¯CPUå¯†é›†å‹çš„ç¨‹åºï¼‰ã€‚åœ¨STW æ ‡è®°ç»ˆæ­¢çš„ç»“å°¾ï¼Œæ‰€æœ‰çš„spanéƒ½è¢«æ ‡è®°ä¸ºéœ€è¦æ¸…é™¤ã€‚</p>
<p>åå°æ¸…é™¤ goroutine ç®€å•åœ°é€ä¸ªæ¸…é™¤spanã€‚</p>
<p>ä¸ºäº†é¿å…åœ¨å­˜åœ¨æœªæ¸…é™¤çš„spanæ—¶è¯·æ±‚æ›´å¤šçš„OSå†…å­˜ï¼Œå½“goroutineéœ€è¦å¦ä¸€ä¸ªspanæ—¶ï¼Œå®ƒé¦–å…ˆå°è¯•é€šè¿‡æ¸…é™¤æ¥å›æ”¶è¿™äº›å†…å­˜ã€‚
å½“ goroutine éœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„å°å¯¹è±¡spanæ—¶ï¼Œå®ƒä¼šæ¸…é™¤ç›¸åŒå¤§å°çš„å°å¯¹è±¡spanï¼Œç›´åˆ°é‡Šæ”¾è‡³å°‘ä¸€ä¸ªå¯¹è±¡ä¸ºæ­¢ã€‚
å½“ goroutine éœ€è¦ä»å †ä¸­åˆ†é…å¤§å¯¹è±¡spanæ—¶ï¼Œå®ƒä¼šæ¸…é™¤spanï¼Œç›´åˆ°å°†è‡³å°‘é‚£ä¹ˆå¤šé¡µé¢é‡Šæ”¾åˆ°å †ä¸­ã€‚
æœ‰ä¸€ç§æƒ…å†µï¼Œè¿™å¯èƒ½æ˜¯ä¸å¤Ÿçš„ï¼šå¦‚æœ goroutine æ¸…é™¤å¹¶é‡Šæ”¾ä¸¤ä¸ªä¸ç›¸é‚»çš„å•é¡µspanåˆ°å †ä¸­ï¼Œé‚£ä¹ˆå®ƒå°†åˆ†é…ä¸€ä¸ªæ–°çš„åŒé¡µspanï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥æœ‰å…¶ä»–å•é¡µæœªæ¸…é™¤çš„spanï¼Œå¯ä»¥ç»„åˆæˆåŒé¡µçš„spanã€‚</p>
<p>ç¡®ä¿åœ¨æœªæ¸…é™¤çš„spanä¸Šä¸è¿›è¡Œä»»ä½•æ“ä½œï¼ˆè¿™ä¼šç ´å GC ä½å›¾ä¸­çš„æ ‡è®°ä½ï¼‰è‡³å…³é‡è¦ã€‚
åœ¨ GC æœŸé—´ï¼Œæ‰€æœ‰mcacheéƒ½è¢«åˆ·æ–°åˆ°ä¸­å¤®ç¼“å­˜ä¸­ï¼Œå› æ­¤å®ƒä»¬æ˜¯ç©ºçš„ã€‚
å½“ä¸€ä¸ª goroutine æŠ“å–ä¸€ä¸ªæ–°çš„spanåˆ°mcacheæ—¶ï¼Œgoroutineä¼šæ¸…é™¤mcacheã€‚
å½“ goroutine æ˜¾å¼é‡Šæ”¾å¯¹è±¡æˆ–è®¾ç½®finalizeræ—¶ï¼Œgoroutine ç¡®ä¿spanå·²ç»æ¸…é™¤ï¼ˆé€šè¿‡æ¸…é™¤æˆ–è€…ç­‰å¾…å¹¶å‘æ¸…é™¤å®Œæˆï¼‰ã€‚
finalizer goroutineä»…åœ¨æ‰€æœ‰spanå·²ç»æ¸…é™¤æ—¶æ‰å¼€å§‹ã€‚
å½“ä¸‹ä¸€æ¬¡ GC å¯åŠ¨æ—¶ï¼Œå®ƒå°†æ¸…é™¤æ‰€æœ‰å°šæœªæ¸…é™¤çš„spanï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚</p>
<p>ä¸‹ä¸€æ¬¡ GC æ˜¯åœ¨æˆ‘ä»¬åˆ†é…äº†ä¸å·²ç»ä½¿ç”¨çš„å†…å­˜æˆæ­£æ¯”çš„é¢å¤–å†…å­˜æ—¶è§¦å‘ï¼›
è¯¥æ¯”ä¾‹ç”±GOGCç¯å¢ƒå˜é‡æ§åˆ¶ï¼ˆé»˜è®¤ä¸º100ï¼‰ã€‚
å¦‚æœGOGC=100ï¼Œè€Œæˆ‘ä»¬å½“å‰ä½¿ç”¨çš„å†…å­˜çš„æ˜¯4Mï¼Œé‚£ä¹ˆå½“è¾¾åˆ°8Mæ—¶ï¼Œè§¦å‘GCã€‚</p>
<p>ä¸ºäº†é˜²æ­¢åœ¨æ‰«æå¤§å‹å¯¹è±¡æ—¶å‡ºç°é•¿æ—¶é—´çš„æš‚åœï¼Œä¸æé«˜å¹¶è¡Œæ€§ï¼Œåƒåœ¾æ”¶é›†å™¨å°†å¤§äºmaxObletBytesçš„å¯¹è±¡çš„æ‰«æä½œä¸šåˆ†è§£ä¸ºæœ€å¤šmaxObletBytesçš„obletsæ•°ç»„ã€‚
å½“æ‰«æé‡åˆ°å¤§å¯¹è±¡æ—¶ï¼Œå®ƒåªæ‰«æç¬¬ä¸€ä¸ª<a href="https://wiki.tcl-lang.org/page/Oblets">oblet</a>ï¼Œå¹¶å°†å…¶ä½™obletsä½œä¸ºæ–°çš„æ‰«æä½œä¸šæ’é˜Ÿã€‚</p>
<p>tri-color mark and sweep.</p>
<ol>
<li>Mark Setup - STW
å†™å±éšœï¼Œæ‰€æœ‰gè¿›å…¥å®‰å…¨ç‚¹</li>
<li>Marking - Concurrent
å æ®1/4å¯ç”¨çš„cpu
GCç‹¬å ä¸€ä¸ªGMP
æ‰¾åˆ°å †å†…å­˜çš„æ ¹å¯¹è±¡
é€šè¿‡æ ¹å¯¹è±¡éå†å †å†…å­˜å›¾
P1 in GC,other ps still work
å¯ä½¿ç”¨gååŠ©æ ‡è®°</li>
<li>Mark Termination - STW
å…³é—­å†™å±éšœï¼Œæ¸…æ¥šä»»åŠ¡
è®¡ç®—ä¸‹æ¬¡GCç›®æ ‡</li>
<li>Sweeping
å½“ç”¨æˆ·gå°è¯•å†å¯¹ä¸Šåˆ†é…æ–°å€¼æ—¶å‘ç”Ÿ</li>
</ol>
<pre class="astro-code nord" style="background-color:#2e3440ff;color:#d8dee9ff; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#616E88">// GC åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼Œæ¸…é™¤ç»ˆç»“ï¼Œæ ‡è®°ï¼Œæ ‡è®°ç»ˆç»“ï¼Œæ¸…é™¤</span></span>
<span class="line"><span style="color:#616E88">// å½“å¤„äºå‰ä¸‰ä¸ªæ­¥éª¤æ—¶ï¼Œç­‰å¾…åˆ°æ¸…é™¤é˜¶æ®µï¼ŒåŒæ—¶è¾…åŠ©æ¸…é™¤</span></span>
<span class="line"><span style="color:#616E88">// è¾…åŠ©æ¸…é™¤æ—¶ï¼Œå¯ä»¥è§¦å‘ä¸‹ä¸€æ¬¡GC</span></span>
<span class="line"><span style="color:#616E88">// ç­‰å¾…ä¸‹ä¸€æ¬¡GCçš„å‰ä¸‰é˜¶æ®µå®Œæˆï¼Œç„¶åè¾…åŠ©æ¸…é™¤</span></span>
<span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> GC</span><span style="color:#ECEFF4">(){}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// è§¦å‘GC</span></span>
<span class="line"><span style="color:#616E88">// triggerå®šä¹‰è§¦å‘çš„ç±»å‹ï¼šå †å¤§å°/æ—¶é—´/æ¬¡æ•°</span></span>
<span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> gcStart</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">trigger</span><span style="color:#D8DEE9FF"> gcTrigger</span><span style="color:#ECEFF4">){}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// æ¸…é™¤æœªæ¸…é™¤çš„å †spanï¼Œè¿”å›å½’è¿˜ç»™å †çš„é¡µæ•°é‡</span></span>
<span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> sweepone</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1"> uintptr</span><span style="color:#ECEFF4">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616E88">// æ˜¯å¦æ‰€æœ‰spanè¢«æ¸…é™¤</span></span>
<span class="line"><span style="color:#81A1C1">func</span><span style="color:#88C0D0"> isSweepDone</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1"> bool</span><span style="color:#ECEFF4">{}</span></span></code></pre>
<h4 id="0021--gc-trace">0.0.2.1 Â· GC trace</h4>
<p>GODEBUG=gctrace=1 go run main.go
GODEBUG=gctrace=1 ./main</p>
<p>gc 1405 @6.068s 11%: 0.058+1.2+0.083 ms clock, 0.70+2.5/1.5/0+0.99 ms cpu, 7->11->6 MB, 10 MB goal, 12 P</p>
<p>// General
gc 1404     : The 1404 GC run since the program started
@6.068s     : Six seconds since the program started
11%         : Eleven percent of the available CPU so far has been spent in GC</p>
<p>// Wall-Clock
0.058ms     : STW        : Mark Start       - Write Barrier on
1.2ms       : Concurrent : Marking
0.083ms     : STW        : Mark Termination - Write Barrier off and clean up</p>
<p>// CPU Time
0.70ms      : STW        : Mark Start
2.5ms       : Concurrent : Mark - Assist Time (GC performed in line with allocation)
1.5ms       : Concurrent : Mark - Background GC time
0ms         : Concurrent : Mark - Idle GC time
0.99ms      : STW        : Mark Term</p>
<p>// Memory
7MB         : Heap memory in-use before the Marking started
11MB        : Heap memory in-use after the Marking finished
6MB         : Heap memory marked as live after the Marking finished
10MB        : Collection goal for heap memory in-use after Marking finished</p>
<p>// Threads
12P         : Number of logical processors or threads used to run Goroutines</p>
<h4 id="0022--pacing">0.0.2.2 Â· pacing</h4>
<p>gcpacertrace=1</p>
<p>pacing algorithm determine when a collection is to start.
feedback loop,gather information about the running application,stress the application is putting on the heap.Stress can be defined as how fast the application is allocating heap memory within a given amount of time.stress that determines the pace at which the collector needs to run.</p>
<p>Before the collector starts a collection,
it calculates the amount of time it believes it will take to finish the collection.</p>
<h4 id="0023--collector-latency-costs">0.0.2.3 Â· Collector Latency Costs</h4>
<p>help collecotr:</p>
<ol>
<li>Maintain the smallest heap possible.
å°½å¯èƒ½ç»´æŒä¸€ä¸ªæœ€å°çš„å †ï¼›</li>
<li>Find an optimal consistent pace.
æ‰¾åˆ°ä¸€ä¸ªæœ€ä½³çš„èŠ‚å¥ï¼›</li>
<li>Stay within the goal for every collection.
ä¿æŒåœ¨æ¯ä¸ªé›†åˆçš„ç›®æ ‡èŒƒå›´å†…</li>
<li>Minimize the duration of every collection, STW and Mark Assist.
æœ€å¤§é™åº¦åœ°ç¼©çŸ­æ¯æ¬¡æ”¶é›†ã€STW å’Œ Mark Assist çš„æŒç»­æ—¶é—´ã€‚</li>
</ol>
<h4 id="0024--stack">0.0.2.4 Â· stack</h4>
<p><a href="https://docs.google.com/document/d/1un-Jn47yByHL7I0aVIP_uVCMxjdM5mpelJhiKlIqxkE/edit#">https://docs.google.com/document/d/1un-Jn47yByHL7I0aVIP_uVCMxjdM5mpelJhiKlIqxkE/edit#</a></p>
<h2 id="01--garbage-collection">0.1 Â· Garbage collection</h2>
<h3 id="011--gc-phases">0.1.1 Â· GC Phases</h3>
<p>Mark prepare<br>
Concurrent marking<br>
Mark termination<br>
Background sweep , scvg</p>
<h3 id="012--stw">0.1.2 Â· STW</h3>
<p>OLD:
NEW: Stack Rescan has been elimited</p>
<h3 id="013--tri-color-mark--sweep">0.1.3 Â· Tri-color mark &#x26;&#x26; sweep</h3>
<p>colors: gray white black
Background mark workers
Gc assist</p>
<h3 id="014--gc-writer-barrier">0.1.4 Â· GC writer barrier</h3>
<p>Insert when compile</p>
<h3 id="015--gc-pacing-algorithm">0.1.5 Â· Gc pacing algorithm</h3>
<p>GOGC</p> <!-- Diagrams rendered at build time -->  </article> <nav class="mt-12 pt-8 border-t border-nord-4 dark:border-nord-1" data-astro-cid-v5yihett> <a href="/notes" class="btn-primary" data-astro-cid-v5yihett> <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" data-astro-cid-v5yihett> <path d="M15 19l-7-7 7-7" data-astro-cid-v5yihett></path> </svg>
Back to Notes
</a> </nav>  </main> <footer class="border-t border-nord-5 dark:border-nord-1 mt-12"> <div class="max-w-4xl mx-auto px-4 py-6 text-sm text-nord-3 dark:text-nord-4 text-center"> <p>&copy; 2026. All rights reserved.</p> </div> </footer> <script type="module" src="/_astro/Base.astro_astro_type_script_index_0_lang.WDMQca9J.js"></script> <script>
      (function() {
        const root = document.getElementById('series-dropdown-root');
        const trigger = document.getElementById('series-dropdown-trigger');
        const panel = document.getElementById('series-dropdown-panel');
        const listEl = document.getElementById('series-dropdown-list');
        if (!root || !trigger || !panel || !listEl) return;

        let seriesList = null;
        let hoverTimeout = null;

        function open() {
          panel.classList.remove('hidden');
          trigger.setAttribute('aria-expanded', 'true');
          if (seriesList === null) {
            fetch('/series-list.json')
              .then((r) => r.json())
              .then((list) => {
                seriesList = list;
                if (list.length === 0) {
                  listEl.innerHTML = '<span class="block px-3 py-2 text-xs text-nord-4 dark:text-nord-3">æš‚æ— ç³»åˆ—</span>';
                } else {
                  listEl.innerHTML = list.map(function(name) {
                     const slug = name.toLowerCase().replace(/\s+/g, '-');
                     const url = '/notes/series/' + slug;
                     return '<a href="' + url + '" class="block px-3 py-2 text-sm text-nord-9 dark:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-2 transition-colors" role="menuitem">' + escapeHtml(name) + '</a>';
                   }).join('');
                }
              })
              .catch(function() {
                listEl.innerHTML = '<span class="block px-3 py-2 text-xs text-nord-11">åŠ è½½å¤±è´¥</span>';
              });
          }
        }

        function close() {
          panel.classList.add('hidden');
          trigger.setAttribute('aria-expanded', 'false');
        }

        function escapeHtml(s) {
          const div = document.createElement('div');
          div.textContent = s;
          return div.innerHTML;
        }

        // On click: allow default navigation to /notes/series
        // On hover: show dropdown menu
        trigger.addEventListener('click', function(e) {
          e.stopPropagation();
          // Don't preventDefault - allow link to navigate
        });

        trigger.addEventListener('mouseenter', function() {
          if (hoverTimeout) clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(open, 200);
        });

        root.addEventListener('mouseleave', function() {
          if (hoverTimeout) { clearTimeout(hoverTimeout); hoverTimeout = null; }
          hoverTimeout = setTimeout(close, 150);
        });

        panel.addEventListener('mouseenter', function() {
          if (hoverTimeout) { clearTimeout(hoverTimeout); hoverTimeout = null; }
        });

        document.addEventListener('click', function(e) {
          if (!root.contains(e.target)) close();
        });
      })();
    </script> <script>
      (function() {
        const root = document.getElementById('tags-dropdown-root');
        const trigger = document.getElementById('tags-dropdown-trigger');
        const panel = document.getElementById('tags-dropdown-panel');
        const listEl = document.getElementById('tags-dropdown-list');
        if (!root || !trigger || !panel || !listEl) return;

        let tagList = null;
        let hoverTimeout = null;

        function open() {
          panel.classList.remove('hidden');
          trigger.setAttribute('aria-expanded', 'true');
          if (tagList === null) {
            fetch('/tag-list.json')
              .then((r) => r.json())
              .then((list) => {
                tagList = list;
                if (list.length === 0) {
                  listEl.innerHTML = '<span class="block px-3 py-2 text-xs text-nord-4 dark:text-nord-3">æš‚æ— æ ‡ç­¾</span>';
                } else {
                  listEl.innerHTML = list.map(function(tag) {
                     const url = '/notes/tag/' + encodeURIComponent(tag);
                     return '<a href="' + url + '" class="block px-3 py-2 text-sm text-nord-9 dark:text-nord-8 hover:bg-nord-5 dark:hover:bg-nord-2 transition-colors" role="menuitem">' + escapeHtml(tag) + '</a>';
                   }).join('');
                }
              })
              .catch(function() {
                listEl.innerHTML = '<span class="block px-3 py-2 text-xs text-nord-11">åŠ è½½å¤±è´¥</span>';
              });
          }
        }

        function close() {
          panel.classList.add('hidden');
          trigger.setAttribute('aria-expanded', 'false');
        }

        function escapeHtml(s) {
          const div = document.createElement('div');
          div.textContent = s;
          return div.innerHTML;
        }

        trigger.addEventListener('click', function(e) {
          e.stopPropagation();
        });

        trigger.addEventListener('mouseenter', function() {
          if (hoverTimeout) clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(open, 200);
        });

        root.addEventListener('mouseleave', function() {
          if (hoverTimeout) { clearTimeout(hoverTimeout); hoverTimeout = null; }
          hoverTimeout = setTimeout(close, 150);
        });

        panel.addEventListener('mouseenter', function() {
          if (hoverTimeout) { clearTimeout(hoverTimeout); hoverTimeout = null; }
        });

        document.addEventListener('click', function(e) {
          if (!root.contains(e.target)) close();
        });
      })();
    </script> </body> </html>  <script>
  // Language aliases (matches server-side)
  const langAliases = {
    js: 'javascript',
    ts: 'typescript',
    yml: 'yaml',
    yaml: 'yaml',
    sh: 'bash',
    shell: 'bash',
    sql: 'postgresql',
    java: 'openjdk',
  };

  // Add headers and copy buttons to code blocks
  function initCodeBlocks() {
    document.querySelectorAll('pre[data-language]').forEach((pre) => {
      // Skip if already processed
      if (pre.parentNode.classList.contains('code-block-wrapper')) return;
      
      const lang = pre.getAttribute('data-language') || 'code';
      
      // Create wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);
      
      // Create header
      const header = document.createElement('div');
      header.className = 'code-header';
      
      const langSpan = document.createElement('span');
      langSpan.className = 'code-header-lang';
      langSpan.title = lang;
      
      // Normalize lang for devicon
      const normalizedLang = lang.toLowerCase();
      const iconLang = langAliases[normalizedLang] || normalizedLang;
      
      // Display language with devicon (format: devicon-{name}-{version} colored)
      const iconEl = document.createElement('i');
      iconEl.className = `devicon-${iconLang}-plain colored`;
      iconEl.style.marginRight = '0.375rem';
      iconEl.style.fontSize = '0.75rem';
      langSpan.appendChild(iconEl);
      langSpan.appendChild(document.createTextNode(lang));
      
      const button = document.createElement('button');
      button.className = 'copy-code-btn';
      button.title = 'Copy to clipboard';
      button.innerHTML = '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      
      let isCopying = false;
      button.addEventListener('click', async () => {
        if (isCopying) return;
        isCopying = true;
        
        const code = pre.querySelector('code')?.textContent || '';
        try {
          await navigator.clipboard.writeText(code);
          const originalHtml = button.innerHTML;
          button.innerHTML = '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
          button.title = 'Copied!';
          setTimeout(() => {
            button.innerHTML = originalHtml;
            button.title = 'Copy to clipboard';
            isCopying = false;
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          isCopying = false;
        }
      });
      
      header.appendChild(langSpan);
      header.appendChild(button);
      wrapper.appendChild(header);
    });
  }

  // Run ASAP, then on DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCodeBlocks);
  } else {
    initCodeBlocks();
  }

  // Convert wikilinks to links on client side
  // Matches [[ref]] or [[ref|display text]]
  document.addEventListener('DOMContentLoaded', () => {
    const wikiRegex = /\[\[([a-zA-Z0-9][a-zA-Z0-9_-]*?)(?:\|([^\]]+))?\]\]/g;
    
    // Process all text nodes in prose content
    const walker = document.createTreeWalker(
      document.querySelector('.prose') || document.body,
      NodeFilter.SHOW_TEXT,
      null,
      false
    );
    
    const nodesToReplace = [];
    let node;
    
    while (node = walker.nextNode()) {
      if (node.nodeValue.includes('[[')) {
        nodesToReplace.push(node);
      }
    }
    
    nodesToReplace.forEach((textNode) => {
      const parent = textNode.parentNode;
      let lastIndex = 0;
      const matches = [...textNode.nodeValue.matchAll(wikiRegex)];
      
      if (matches.length === 0) return;
      
      const fragment = document.createDocumentFragment();
      
      matches.forEach((match) => {
        const [fullMatch, ref, displayText] = match;
        const startIndex = match.index;
        
        // Add text before match
        if (startIndex > lastIndex) {
          fragment.appendChild(
            document.createTextNode(textNode.nodeValue.slice(lastIndex, startIndex))
          );
        }
        
        // Create link
        const link = document.createElement('a');
        link.href = `/notes/${ref.toLowerCase()}`;
        link.textContent = (displayText || ref).trim();
        link.className = 'text-nord-9 dark:text-nord-8 hover:text-nord-10 dark:hover:text-nord-7 transition-colors';
        fragment.appendChild(link);
        
        lastIndex = startIndex + fullMatch.length;
      });
      
      // Add remaining text
      if (lastIndex < textNode.nodeValue.length) {
        fragment.appendChild(
          document.createTextNode(textNode.nodeValue.slice(lastIndex))
        );
      }
      
      parent.replaceChild(fragment, textNode);
    });
  });
</script> 